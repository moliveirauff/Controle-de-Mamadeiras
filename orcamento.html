<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="only light">
  <meta name="supported-color-schemes" content="light">
  <title>üí∞ Dashboard de Or√ßamento</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <style>
    /* Force Light Mode variables as default, override if class is present */
    :root {
      color-scheme: only light !important;
      isolation: isolate;
      --bg: #f7fafc;
      --text: #2d3748;
      --surface: #ffffff;
      --card-bg: var(--surface);
      --border: #e2e8f0;
      --text-muted: #718096;
      --subtext: var(--text-muted);
      --primary: #667eea;
      --accent: var(--primary);
      --success: #48bb78;
      --warning: #ed8936;
      --danger: #f56565;
      --shadow: 0 1px 3px rgba(0,0,0,.08), 0 4px 16px rgba(0,0,0,.06);
    }
    
    /* Apply Dark Mode only when class is present */
    body.dark-mode {
      color-scheme: only dark !important;
      --bg: #1a202c;
      --text: #f7fafc;
      --surface: #2d3748;
      --card-bg: var(--surface);
      --border: #4a5568;
      --text-muted: #cbd5e0;
      --subtext: var(--text-muted);
      --primary: #7f9cf5;
      --accent: var(--primary);
      background-image: none;
      background-color: var(--bg);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html {
      background-color: var(--bg);
      min-height: 100vh;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      transition: background-color 0.3s, color 0.3s;
      padding: 10px 10px 60px 10px;
      min-height: 100vh;
    }

    /* Header */
    #theme-toggle {
      position: absolute; top: 12px; right: 12px;
      background: rgba(0,0,0,0.05); border: none; font-size: 1.2rem; cursor: pointer;
      padding: 8px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      z-index: 10; transition: background 0.2s;
    }
    body.dark-mode #theme-toggle { background: rgba(255,255,255,0.1); }
    body:not(.dark-mode) #theme-toggle { background: rgba(0,0,0,0.05); }
    .nav-link {
      text-decoration: none;
      color: var(--primary);
      font-size: 0.9rem;
      margin: 10px 0 0 4px;
      display: inline-block;
    }
    h1 {
      text-align: center;
      font-size: 1.5rem;
      font-weight: 800;
      margin: 10px 44px 20px 44px;
      color: var(--text);
    }

    /* KPIs */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    .kpi-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 8px;
      text-align: center;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .kpi-label {
      font-size: 0.6rem;
      font-weight: 800;
      color: var(--subtext);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      order: 1;
    }
    .kpi-value {
      font-size: 1.05rem;
      font-weight: 800;
      color: var(--text);
      line-height: 1.2;
      order: 2;
    }
    .kpi-sub {
      font-size: 0.65rem;
      color: var(--text-muted);
      font-weight: 600;
      order: 3;
    }

    /* Cards */
    .card {
      background: var(--surface);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
      transition: background-color 0.3s, border-color 0.3s;
    }
    .card-header {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .card-title { 
      display: flex; 
      align-items: center; 
      gap: 6px;
      text-align: center;
      width: 100%;
      justify-content: center;
    }
    .card-header .controls {
      width: 100%;
      justify-content: center;
    }

    /* Chart */
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }

    /* Controls */
    .controls { 
      display: flex; 
      gap: 6px; 
      align-items: center; 
      flex-wrap: wrap;
      justify-content: center;
    }
    .btn-period {
      background: var(--border);
      border: none;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-period:hover { opacity: 0.8; }
    .btn-period.active { background: var(--accent); color: white; }

    /* Loading */
    #loading {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      color: white;
      font-weight: bold;
      backdrop-filter: blur(4px);
    }
    .hidden { display: none !important; }

    /* Desktop */
    @media (min-width: 768px) {
      body { max-width: 960px; margin: 0 auto; padding: 16px 16px 60px 16px; }
      h1 { font-size: 1.75rem; }
      .kpi-grid { grid-template-columns: repeat(4, 1fr); gap: 12px; }
      .chart-container { height: 380px; }
    }
  </style>
</head>
<body>

<div id="loading">Carregando dados...</div>

<button id="theme-toggle" onclick="toggleTheme()">üåô</button>
<a href="index.html" class="nav-link">‚Üê Voltar</a>
<h1>üí∞ Or√ßamento</h1>

<main>
  <!-- KPIs -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <span class="kpi-label">üí∞ Total de Entradas</span>
      <span class="kpi-value" id="kpiTotal">‚Äî</span>
      <span class="kpi-sub">√öltimos 12 meses</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-label">üìÖ M√©dia Mensal</span>
      <span class="kpi-value" id="kpiMedia">‚Äî</span>
      <span class="kpi-sub">√öltimos 12 meses</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-label">üéØ Taxa de Poupan√ßa</span>
      <span class="kpi-value" id="kpiTaxa">‚Äî</span>
      <span class="kpi-sub">√öltimos 12 meses</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-label">üéÅ M√©dia Passiva</span>
      <span class="kpi-value" id="kpiPassiva">‚Äî</span>
      <span class="kpi-sub">Sem sal√°rio (12M)</span>
    </div>
  </div>

  <!-- Chart: Evolu√ß√£o Anual -->
  <div class="card">
    <div class="card-header">
      <div class="card-title"><span>üìä</span> Evolu√ß√£o Anual</div>
    </div>
    <div class="chart-container"><canvas id="cAnual"></canvas></div>
  </div>

  <!-- Chart: Evolu√ß√£o Mensal -->
  <div class="card">
    <div class="card-header">
      <div class="card-title"><span>üìà</span> Evolu√ß√£o Mensal</div>
      <div class="controls">
        <button class="btn-period active" onclick="setPeriodMensal('12m', this)">12M</button>
        <button class="btn-period" onclick="setPeriodMensal('24m', this)">24M</button>
        <button class="btn-period" onclick="setPeriodMensal('36m', this)">36M</button>
        <button class="btn-period" onclick="setPeriodMensal('todos', this)">Todos</button>
      </div>
    </div>
    <div class="chart-container"><canvas id="cMensal"></canvas></div>
  </div>

  <!-- Chart: Donut -->
  <div class="card">
    <div class="card-header">
      <div class="card-title"><span>ü•ß</span> % por Subcategoria (12M)</div>
    </div>
    <div class="chart-container"><canvas id="cDonut"></canvas></div>
  </div>

  <!-- Chart: Taxa de Poupan√ßa -->
  <div class="card">
    <div class="card-header">
      <div class="card-title"><span>üí∞</span> Taxa de Poupan√ßa por Ano</div>
    </div>
    <div class="chart-container"><canvas id="cTaxaAnual"></canvas></div>
  </div>
</main>

<script>
// Desabilitar datalabels globalmente
Chart.defaults.set('plugins.datalabels', { display: false });

// ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ
const COLORS = {
  salario: '#48bb78',          // Verde
  beneficios: '#667eea',       // Roxo
  outras: '#9b59b6',           // Roxo claro
  proventos: '#f39c12',        // Laranja
  opcoes: '#e74c3c',           // Vermelho
  receitaIndireta: '#3498db'   // Azul
};

const LABELS = {
  salario: 'Sal√°rio',
  beneficios: 'Benef√≠cios',
  outras: 'Outras Receitas',
  proventos: 'Proventos',
  opcoes: 'Op√ß√µes',
  receitaIndireta: 'Receita Indireta'
};

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
let allData = {
  salario: [],
  beneficios: [],
  outrasReceitas: [],
  proventos: [],
  opcoes: [],
  receitaIndireta: [],
  despesas: []
};
let filteredData12M = {};
let filteredDataMensal = {};
let currentPeriodMensal = '12m';
let charts = {};

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ
function brl(v) {
  return 'R$ ' + v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function compactFmt(n) {
  return Intl.NumberFormat('pt-BR', { notation: "compact", compactDisplay: "short" }).format(n);
}

function monthLabel(key) {
  const [y, m] = key.split('-');
  return new Date(parseInt(y), parseInt(m) - 1, 1)
    .toLocaleString('pt-BR', { month: 'short', year: '2-digit' })
    .replace('.', '');
}

function somaValores(arr) {
  return arr.reduce((sum, r) => sum + (r.valor || r.valor_total || 0), 0);
}

function mesesUnicos(arr) {
  return [...new Set(arr.map(r => r.data.substring(0, 7)))].length;
}

function anosUnicos(arr) {
  return [...new Set(arr.map(r => r.data.substring(0, 4)))].sort();
}

// ‚îÄ‚îÄ‚îÄ THEME ‚îÄ‚îÄ‚îÄ
function updateMetaThemeColor(isDark) {
  const color = isDark ? '#1a202c' : '#f7fafc';
  const scheme = isDark ? 'only dark' : 'only light';
  
  let metaTheme = document.querySelector('meta[name="theme-color"]');
  if (!metaTheme) {
    metaTheme = document.createElement('meta');
    metaTheme.name = 'theme-color';
    document.head.appendChild(metaTheme);
  }
  metaTheme.content = color;

  let metaScheme = document.querySelector('meta[name="color-scheme"]');
  if (!metaScheme) {
    metaScheme = document.createElement('meta');
    metaScheme.name = 'color-scheme';
    document.head.appendChild(metaScheme);
  }
  metaScheme.content = scheme;
}

function initTheme() {
  const savedTheme = localStorage.getItem('theme');
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  
  let isDark = false;
  if (savedTheme === 'dark') {
    isDark = true;
  } else if (savedTheme === 'light') {
    isDark = false;
  } else if (prefersDark) {
    isDark = true;
  }
  
  if (isDark) {
    document.body.classList.add('dark-mode');
    document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è';
  } else {
    document.body.classList.remove('dark-mode');
    document.getElementById('theme-toggle').textContent = 'üåô';
  }
  updateMetaThemeColor(isDark);
}

function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  const isDark = document.body.classList.contains('dark-mode');
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
  document.getElementById('theme-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  updateMetaThemeColor(isDark);
  setTimeout(renderAll, 50);
}

// ‚îÄ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ‚îÄ
function setPeriodMensal(period, btn) {
  currentPeriodMensal = period;
  const parent = btn.parentElement;
  parent.querySelectorAll('.btn-period').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  applyFilterMensal();
  renderMensal();
}

function applyFilter12M() {
  const combinedReceitas = [
    ...allData.salario,
    ...allData.beneficios,
    ...allData.outrasReceitas,
    ...allData.proventos,
    ...allData.opcoes,
    ...allData.receitaIndireta
  ];
  
  if (!combinedReceitas.length) {
    filteredData12M = { salario: [], beneficios: [], outrasReceitas: [], proventos: [], opcoes: [], receitaIndireta: [], despesas: [] };
    return;
  }

  const lastKey = combinedReceitas.reduce((max, r) => r.data > max ? r.data : max, '');
  const refDate = lastKey ? new Date(lastKey + 'T00:00') : new Date();
  
  const cutoff = new Date(refDate.getFullYear(), refDate.getMonth() - 11, 1);
  const cutKey = `${cutoff.getFullYear()}-${String(cutoff.getMonth() + 1).padStart(2, '0')}`;

  filteredData12M = {
    salario: allData.salario.filter(r => r.data.substring(0, 7) >= cutKey),
    beneficios: allData.beneficios.filter(r => r.data.substring(0, 7) >= cutKey),
    outrasReceitas: allData.outrasReceitas.filter(r => r.data.substring(0, 7) >= cutKey),
    proventos: allData.proventos.filter(r => r.data.substring(0, 7) >= cutKey),
    opcoes: allData.opcoes.filter(r => r.data.substring(0, 7) >= cutKey),
    receitaIndireta: allData.receitaIndireta.filter(r => r.data.substring(0, 7) >= cutKey),
    despesas: allData.despesas.filter(r => r.data.substring(0, 7) >= cutKey)
  };
}

function applyFilterMensal() {
  const combinedReceitas = [
    ...allData.salario,
    ...allData.beneficios,
    ...allData.outrasReceitas,
    ...allData.proventos,
    ...allData.opcoes,
    ...allData.receitaIndireta
  ];
  
  if (!combinedReceitas.length) {
    filteredDataMensal = { salario: [], beneficios: [], outrasReceitas: [], proventos: [], opcoes: [], receitaIndireta: [], despesas: [] };
    return;
  }

  const lastKey = combinedReceitas.reduce((max, r) => r.data > max ? r.data : max, '');
  const refDate = lastKey ? new Date(lastKey + 'T00:00') : new Date();

  let cutKey = '';
  if (currentPeriodMensal === 'todos') {
    cutKey = '0000-00';
  } else {
    const months = parseInt(currentPeriodMensal);
    const cutoff = new Date(refDate.getFullYear(), refDate.getMonth() - months + 1, 1);
    cutKey = `${cutoff.getFullYear()}-${String(cutoff.getMonth() + 1).padStart(2, '0')}`;
  }

  filteredDataMensal = {
    salario: allData.salario.filter(r => r.data.substring(0, 7) >= cutKey),
    beneficios: allData.beneficios.filter(r => r.data.substring(0, 7) >= cutKey),
    outrasReceitas: allData.outrasReceitas.filter(r => r.data.substring(0, 7) >= cutKey),
    proventos: allData.proventos.filter(r => r.data.substring(0, 7) >= cutKey),
    opcoes: allData.opcoes.filter(r => r.data.substring(0, 7) >= cutKey),
    receitaIndireta: allData.receitaIndireta.filter(r => r.data.substring(0, 7) >= cutKey),
    despesas: allData.despesas.filter(r => r.data.substring(0, 7) >= cutKey)
  };
}

// ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ
function renderAll() {
  updateKPIs();
  renderAnual();
  renderMensal();
  renderDonut();
  renderTaxaAnual();
}

function updateKPIs() {
  const totalSalario = somaValores(filteredData12M.salario);
  const totalBeneficios = somaValores(filteredData12M.beneficios);
  const totalOutras = somaValores(filteredData12M.outrasReceitas);
  const totalProventos = somaValores(filteredData12M.proventos);
  const totalOpcoes = somaValores(filteredData12M.opcoes);
  const totalReceitaIndireta = somaValores(filteredData12M.receitaIndireta);
  const totalReceitas = totalSalario + totalBeneficios + totalOutras + totalProventos + totalOpcoes + totalReceitaIndireta;
  const totalDespesas = Math.abs(somaValores(filteredData12M.despesas));
  
  const allReceitas = [
    ...filteredData12M.salario,
    ...filteredData12M.beneficios,
    ...filteredData12M.outrasReceitas,
    ...filteredData12M.proventos,
    ...filteredData12M.opcoes,
    ...filteredData12M.receitaIndireta
  ];
  const meses = mesesUnicos(allReceitas) || 1;
  
  const mediaTotal = totalReceitas / meses;
  const mediaPassiva = (totalBeneficios + totalOutras + totalProventos + totalOpcoes + totalReceitaIndireta) / meses;
  const taxaPoupanca = totalReceitas > 0 ? ((totalReceitas - totalDespesas) / totalReceitas) * 100 : 0;
  
  document.getElementById('kpiTotal').textContent = brl(totalReceitas);
  document.getElementById('kpiMedia').textContent = brl(mediaTotal);
  document.getElementById('kpiTaxa').textContent = taxaPoupanca.toFixed(1) + '%';
  document.getElementById('kpiPassiva').textContent = brl(mediaPassiva);
}

function renderAnual() {
  const ctx = document.getElementById('cAnual').getContext('2d');
  const textColor = getComputedStyle(document.body).getPropertyValue('--text').trim();
  const gridColor = getComputedStyle(document.body).getPropertyValue('--border').trim();
  
  const allYears = anosUnicos([
    ...allData.salario,
    ...allData.beneficios,
    ...allData.outrasReceitas,
    ...allData.proventos,
    ...allData.opcoes,
    ...allData.receitaIndireta
  ]);
  
  const datasets = [
    {
      label: LABELS.salario,
      data: allYears.map(y => somaValores(allData.salario.filter(r => r.data.substring(0, 4) === y))),
      backgroundColor: COLORS.salario,
      borderRadius: 4,
      stack: 'Stack0'
    },
    {
      label: LABELS.beneficios,
      data: allYears.map(y => somaValores(allData.beneficios.filter(r => r.data.substring(0, 4) === y))),
      backgroundColor: COLORS.beneficios,
      borderRadius: 4,
      stack: 'Stack0'
    },
    {
      label: LABELS.outras,
      data: allYears.map(y => somaValores(allData.outrasReceitas.filter(r => r.data.substring(0, 4) === y))),
      backgroundColor: COLORS.outras,
      borderRadius: 4,
      stack: 'Stack0'
    },
    {
      label: LABELS.proventos,
      data: allYears.map(y => somaValores(allData.proventos.filter(r => r.data.substring(0, 4) === y))),
      backgroundColor: COLORS.proventos,
      borderRadius: 4,
      stack: 'Stack0'
    },
    {
      label: LABELS.opcoes,
      data: allYears.map(y => somaValores(allData.opcoes.filter(r => r.data.substring(0, 4) === y))),
      backgroundColor: COLORS.opcoes,
      borderRadius: 4,
      stack: 'Stack0'
    },
    {
      label: LABELS.receitaIndireta,
      data: allYears.map(y => somaValores(allData.receitaIndireta.filter(r => r.data.substring(0, 4) === y))),
      backgroundColor: COLORS.receitaIndireta,
      borderRadius: 4,
      stack: 'Stack0'
    }
  ];
  
  if (charts.anual) charts.anual.destroy();
  charts.anual = new Chart(ctx, {
    type: 'bar',
    data: { labels: allYears, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { stacked: true, grid: { display: false }, ticks: { color: textColor } },
        y: { 
          stacked: true, 
          ticks: { callback: v => compactFmt(v), color: textColor },
          grid: { color: gridColor }
        }
      },
      plugins: {
        legend: { 
          position: 'bottom', 
          labels: { boxWidth: 12, font: { size: 10 }, color: textColor }
        },
        tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + brl(ctx.raw) } }
      }
    }
  });
}

function renderMensal() {
  const ctx = document.getElementById('cMensal').getContext('2d');
  const textColor = getComputedStyle(document.body).getPropertyValue('--text').trim();
  const gridColor = getComputedStyle(document.body).getPropertyValue('--border').trim();
  
  const allMonths = [...new Set([
    ...filteredDataMensal.salario.map(r => r.data.substring(0, 7)),
    ...filteredDataMensal.beneficios.map(r => r.data.substring(0, 7)),
    ...filteredDataMensal.outrasReceitas.map(r => r.data.substring(0, 7)),
    ...filteredDataMensal.proventos.map(r => r.data.substring(0, 7)),
    ...filteredDataMensal.opcoes.map(r => r.data.substring(0, 7)),
    ...filteredDataMensal.receitaIndireta.map(r => r.data.substring(0, 7))
  ])].sort();
  
  const datasets = [
    {
      label: LABELS.salario,
      data: allMonths.map(m => somaValores(filteredDataMensal.salario.filter(r => r.data.substring(0, 7) === m))),
      backgroundColor: COLORS.salario,
      borderRadius: 4,
      stack: 'Stack0'
    },
    {
      label: LABELS.beneficios,
      data: allMonths.map(m => somaValores(filteredDataMensal.beneficios.filter(r => r.data.substring(0, 7) === m))),
      backgroundColor: COLORS.beneficios,
      borderRadius: 4,
      stack: 'Stack0'
    },
    {
      label: LABELS.outras,
      data: allMonths.map(m => somaValores(filteredDataMensal.outrasReceitas.filter(r => r.data.substring(0, 7) === m))),
      backgroundColor: COLORS.outras,
      borderRadius: 4,
      stack: 'Stack0'
    },
    {
      label: LABELS.proventos,
      data: allMonths.map(m => somaValores(filteredDataMensal.proventos.filter(r => r.data.substring(0, 7) === m))),
      backgroundColor: COLORS.proventos,
      borderRadius: 4,
      stack: 'Stack0'
    },
    {
      label: LABELS.opcoes,
      data: allMonths.map(m => somaValores(filteredDataMensal.opcoes.filter(r => r.data.substring(0, 7) === m))),
      backgroundColor: COLORS.opcoes,
      borderRadius: 4,
      stack: 'Stack0'
    },
    {
      label: LABELS.receitaIndireta,
      data: allMonths.map(m => somaValores(filteredDataMensal.receitaIndireta.filter(r => r.data.substring(0, 7) === m))),
      backgroundColor: COLORS.receitaIndireta,
      borderRadius: 4,
      stack: 'Stack0'
    }
  ];
  
  const labels = allMonths.map(monthLabel);
  
  if (charts.mensal) charts.mensal.destroy();
  charts.mensal = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { 
          stacked: true, 
          grid: { display: false }, 
          ticks: { maxRotation: 45, font: { size: 10 }, color: textColor } 
        },
        y: { 
          stacked: true, 
          ticks: { callback: v => compactFmt(v), color: textColor },
          grid: { color: gridColor }
        }
      },
      plugins: {
        legend: { 
          position: 'bottom', 
          labels: { boxWidth: 12, font: { size: 10 }, color: textColor } 
        }
      }
    }
  });
}

function renderDonut() {
  const ctx = document.getElementById('cDonut').getContext('2d');
  const textColor = getComputedStyle(document.body).getPropertyValue('--text').trim();
  
  const totals = {
    salario: somaValores(filteredData12M.salario),
    beneficios: somaValores(filteredData12M.beneficios),
    outras: somaValores(filteredData12M.outrasReceitas),
    proventos: somaValores(filteredData12M.proventos),
    opcoes: somaValores(filteredData12M.opcoes),
    receitaIndireta: somaValores(filteredData12M.receitaIndireta)
  };
  
  const entries = Object.entries(totals).filter(([k, v]) => v > 0);
  const labels = entries.map(([k]) => LABELS[k]);
  const data = entries.map(([k, v]) => v);
  const colors = entries.map(([k]) => COLORS[k]);
  
  const total = data.reduce((a, b) => a + b, 0);
  
  if (charts.donut) charts.donut.destroy();
  charts.donut = new Chart(ctx, {
    type: 'doughnut',
    data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0 }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '65%',
      plugins: {
        legend: { 
          position: 'right', 
          labels: { boxWidth: 12, font: { size: 10 }, color: textColor } 
        },
        tooltip: {
          callbacks: {
            label: ctx => {
              const pct = ((ctx.parsed / total) * 100).toFixed(1);
              return ` ${brl(ctx.parsed)} (${pct}%)`;
            }
          }
        }
      }
    }
  });
}

function renderTaxaAnual() {
  const ctx = document.getElementById('cTaxaAnual').getContext('2d');
  const textColor = getComputedStyle(document.body).getPropertyValue('--text').trim();
  const gridColor = getComputedStyle(document.body).getPropertyValue('--border').trim();
  
  const allReceitas = [
    ...allData.salario,
    ...allData.beneficios,
    ...allData.outrasReceitas,
    ...allData.proventos,
    ...allData.opcoes,
    ...allData.receitaIndireta
  ];
  const years = anosUnicos([...allReceitas, ...allData.despesas]).filter(y => parseInt(y) >= 2023);
  
  const taxas = years.map(y => {
    const receitasAno = somaValores([
      ...allData.salario.filter(r => r.data.substring(0, 4) === y),
      ...allData.beneficios.filter(r => r.data.substring(0, 4) === y),
      ...allData.outrasReceitas.filter(r => r.data.substring(0, 4) === y),
      ...allData.proventos.filter(r => r.data.substring(0, 4) === y),
      ...allData.opcoes.filter(r => r.data.substring(0, 4) === y),
      ...allData.receitaIndireta.filter(r => r.data.substring(0, 4) === y)
    ]);
    const despesasAno = Math.abs(somaValores(allData.despesas.filter(r => r.data.substring(0, 4) === y)));
    return receitasAno > 0 ? ((receitasAno - despesasAno) / receitasAno) * 100 : 0;
  });
  
  if (charts.taxaAnual) charts.taxaAnual.destroy();
  charts.taxaAnual = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: years,
      datasets: [{
        label: 'Taxa de Poupan√ßa (%)',
        data: taxas,
        backgroundColor: taxas.map(v => v >= 0 ? '#48bb78' : '#f56565'),
        borderRadius: 4,
        datalabels: {
          display: true,
          anchor: 'end',
          align: 'top',
          offset: 4,
          formatter: v => v.toFixed(1) + '%',
          font: { weight: 'bold', size: 10 },
          color: textColor
        }
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: { top: 25 } },
      scales: {
        y: { 
          ticks: { callback: v => v.toFixed(1) + '%', color: textColor },
          grid: { color: gridColor }
        },
        x: {
          ticks: { color: textColor },
          grid: { display: false }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: ctx => `Taxa: ${ctx.raw.toFixed(1)}%` } }
      }
    },
    plugins: [ChartDataLabels]
  });
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
async function init() {
  initTheme();
  
  try {
    const [lancReq, divReq, contraReq, opcoesReq] = await Promise.all([
      fetch('data/lancamentos.json?v=' + Date.now()),
      fetch('data/dividendos_historico.json?v=' + Date.now()),
      fetch('data/contra_cheque.json?v=' + Date.now()),
      fetch('data/fluxo_caixa_opcoes_mensal.json?v=' + Date.now()).catch(() => null)
    ]);
    
    const lancData = await lancReq.json();
    const divData = await divReq.json();
    const contraData = await contraReq.json();
    const opcoesData = opcoesReq ? await opcoesReq.json() : { fluxo_mensal: [] };
    
    // 1. Processar lan√ßamentos (FILTRO: >= 2023)
    const lancamentos = Array.isArray(lancData) ? lancData : (lancData.lancamentos || []);
    const receitas = lancamentos.filter(r => r.categoria === 'receitas' && r.data >= '2023-01-01');
    
    allData.salario = receitas.filter(r => r.subcategoria === 'Sal√°rio');
    allData.beneficios = receitas.filter(r => r.subcategoria === 'Benef√≠cios');
    allData.outrasReceitas = receitas.filter(r => r.subcategoria === 'Outras Receitas');
    
    allData.despesas = lancamentos.filter(r => r.categoria !== 'receitas' && r.data >= '2023-01-01');
    
    // 2. Processar proventos (FILTRO: >= 2023)
    const dividendos = divData.movimentacoes || [];
    dividendos.forEach(d => {
      if (!d.tipo || !d.tipo.startsWith('PROVENTO_') || d.data < '2023-01-01') return;
      
      allData.proventos.push({
        data: d.data,
        valor: d.valor_total,
        categoria: 'receitas',
        subcategoria: 'Proventos',
        origem: d.ativo
      });
    });
    
    // 3. Processar receita indireta (previd√™ncia privada >= 2023)
    contraData.forEach(c => {
      if (!c.mes_referencia || !c.descontos?.previdencia_privada) return;
      
      // Converter mes_referencia ("jan/23") para data ISO
      const meses = {jan:1,fev:2,mar:3,abr:4,mai:5,jun:6,jul:7,ago:8,set:9,out:10,nov:11,dez:12};
      const [mes, ano] = c.mes_referencia.split('/');
      if (!mes || !ano) return;
      
      const anoCompleto = parseInt(ano) < 50 ? `20${ano}` : `19${ano}`;
      const mesNum = String(meses[mes]).padStart(2, '0');
      const data = `${anoCompleto}-${mesNum}-01`;
      
      if (data < '2023-01-01') return;
      
      allData.receitaIndireta.push({
        data,
        valor: c.descontos.previdencia_privada,
        categoria: 'receitas',
        subcategoria: 'Receita Indireta',
        origem: 'contra_cheque'
      });
    });
    
    // 4. Processar op√ß√µes (FILTRO: >= 2023)
    const fluxoMensal = opcoesData.fluxo_mensal || [];
    fluxoMensal.forEach(f => {
      if (!f.mes || !f.total_brl) return;
      
      // Converter "2023-01" para "2023-01-01"
      const data = f.mes + '-01';
      
      if (data < '2023-01-01') return;
      
      allData.opcoes.push({
        data,
        valor: f.total_brl,
        categoria: 'receitas',
        subcategoria: 'Op√ß√µes',
        origem: 'fluxo_caixa_opcoes_mensal'
      });
    });
    
    applyFilter12M();
    applyFilterMensal();
    renderAll();
    document.getElementById('loading').classList.add('hidden');
    
  } catch(err) {
    alert('Erro ao carregar dados: ' + err.message);
    console.error(err);
  }
}

init();
</script>
</body>
</html>
