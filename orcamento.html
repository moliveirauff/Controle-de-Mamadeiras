<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="only light">
  <meta name="supported-color-schemes" content="light">
  <title>üí∞ Dashboard de Or√ßamento</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <style>
    /* Force Light Mode variables as default, override if class is present */
    :root {
      color-scheme: only light !important;
      isolation: isolate;
      --bg: #f7fafc;
      --text: #2d3748;
      --surface: #ffffff;
      --card-bg: var(--surface);
      --border: #e2e8f0;
      --text-muted: #718096;
      --subtext: var(--text-muted);
      --primary: #667eea;
      --accent: var(--primary);
      --success: #48bb78;
      --warning: #ed8936;
      --danger: #f56565;
      --shadow: 0 1px 3px rgba(0,0,0,.08), 0 4px 16px rgba(0,0,0,.06);
    }
    
    /* Apply Dark Mode only when class is present */
    body.dark-mode {
      color-scheme: only dark !important;
      --bg: #1a202c;
      --text: #f7fafc;
      --surface: #2d3748;
      --card-bg: var(--surface);
      --border: #4a5568;
      --text-muted: #cbd5e0;
      --subtext: var(--text-muted);
      --primary: #7f9cf5;
      --accent: var(--primary);
      background-image: none;
      background-color: var(--bg);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html {
      background-color: var(--bg);
      min-height: 100vh;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO+ip1sAAAAASUVORK5CYII=');
      background-repeat: repeat;
      background-color: var(--bg);
      color: var(--text);
      transition: background-color 0.3s, color 0.3s;
      padding: 10px 10px 60px 10px;
      min-height: 100vh;
    }

    /* Header */
    #theme-toggle {
      position: absolute; top: 12px; right: 12px;
      background: rgba(0,0,0,0.05); border: none; font-size: 1.2rem; cursor: pointer;
      padding: 8px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      z-index: 10; transition: background 0.2s;
    }
    body.dark-mode #theme-toggle { background: rgba(255,255,255,0.1); }
    body:not(.dark-mode) #theme-toggle { background: rgba(0,0,0,0.05); }
    .nav-link {
      text-decoration: none;
      color: var(--primary);
      font-size: 0.9rem;
      margin: 10px 0 0 4px;
      display: inline-block;
    }
    h1 {
      text-align: center;
      font-size: 1.5rem;
      font-weight: 800;
      margin: 10px 44px 20px 44px;
      color: var(--text);
    }

    /* Period Filter */
    .period-bar {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 14px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .period-label { 
      font-size: 0.75rem; 
      font-weight: 700; 
      color: var(--subtext); 
      text-transform: uppercase; 
      margin-right: 4px; 
    }
    .btn-period {
      background: var(--border);
      border: none;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-period:hover { opacity: 0.8; }
    .btn-period.active { background: var(--accent); color: white; }

    /* KPIs */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    .kpi-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 8px;
      text-align: center;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .kpi-label {
      font-size: 0.6rem;
      font-weight: 800;
      color: var(--subtext);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      order: 1;
    }
    .kpi-value {
      font-size: 1.05rem;
      font-weight: 800;
      color: var(--text);
      line-height: 1.2;
      order: 2;
    }
    .kpi-sub {
      font-size: 0.65rem;
      color: var(--text-muted);
      font-weight: 600;
      order: 3;
    }

    /* Cards */
    .card {
      background: var(--surface);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
      transition: background-color 0.3s, border-color 0.3s;
    }
    .card-header {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .card-title { 
      display: flex; 
      align-items: center; 
      gap: 6px;
      text-align: center;
      width: 100%;
      justify-content: center;
    }
    .card-header .controls {
      width: 100%;
      justify-content: center;
    }

    /* Chart */
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }

    /* Controls */
    .controls { 
      display: flex; 
      gap: 6px; 
      align-items: center; 
      flex-wrap: wrap;
      justify-content: center;
    }
    .filter-select {
      background: var(--border);
      border: none;
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      outline: none;
    }
    .multiselect-wrapper {
      position: relative;
      display: inline-block;
    }
    .multiselect-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-top: 4px;
      padding: 8px;
      min-width: 200px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      max-height: 300px;
      overflow-y: auto;
    }
    .multiselect-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.85rem;
      transition: background 0.2s;
    }
    .multiselect-option:hover {
      background: var(--border);
    }
    .multiselect-option input[type="checkbox"] {
      cursor: pointer;
    }

    /* Loading */
    #loading {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      color: white;
      font-weight: bold;
      backdrop-filter: blur(4px);
    }
    .hidden { display: none !important; }

    /* Desktop */
    @media (min-width: 768px) {
      body { max-width: 960px; margin: 0 auto; padding: 16px 16px 60px 16px; }
      h1 { font-size: 1.75rem; }
      .kpi-grid { grid-template-columns: repeat(4, 1fr); gap: 12px; }
      .chart-container { height: 380px; }
    }
  </style>
</head>
<body>

<div id="loading">Carregando dados...</div>

<button id="theme-toggle" onclick="toggleTheme()">üåô</button>
<a href="index.html" class="nav-link">‚Üê Voltar</a>
<h1>üí∞ Or√ßamento</h1>

<main>
  <!-- KPIs -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <span class="kpi-label">üí∞ Total de Entradas</span>
      <span class="kpi-value" id="kpiTotal">‚Äî</span>
      <span class="kpi-sub">√öltimos 12 meses</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-label">üìÖ M√©dia Mensal</span>
      <span class="kpi-value" id="kpiMedia">‚Äî</span>
      <span class="kpi-sub">√öltimos 12 meses</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-label">üéØ Taxa de Poupan√ßa</span>
      <span class="kpi-value" id="kpiTaxa">‚Äî</span>
      <span class="kpi-sub">√öltimos 12 meses</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-label">üéÅ M√©dia Passiva</span>
      <span class="kpi-value" id="kpiPassiva">‚Äî</span>
      <span class="kpi-sub">Sem sal√°rio (12M)</span>
    </div>
  </div>

  <!-- Chart: Evolu√ß√£o Anual -->
  <div class="card">
    <div class="card-header">
      <div class="card-title"><span>üìä</span> Evolu√ß√£o Anual</div>
      <div class="controls">
        <div class="multiselect-wrapper">
          <button id="filterAnualBtn" class="filter-select" onclick="toggleAnualFilter(event)">
            <span id="filterAnualLabel">Todas as Fontes</span> ‚ñæ
          </button>
          <div id="filterAnualDropdown" class="multiselect-dropdown" style="display: none;">
            <label class="multiselect-option">
              <input type="checkbox" value="all" checked onchange="toggleAllAnual(this)"> Todas
            </label>
            <label class="multiselect-option">
              <input type="checkbox" value="salario" checked onchange="updateAnualFilter()"> Sal√°rio
            </label>
            <label class="multiselect-option">
              <input type="checkbox" value="outras" checked onchange="updateAnualFilter()"> Outras Receitas
            </label>
            <label class="multiselect-option">
              <input type="checkbox" value="divAcoes" checked onchange="updateAnualFilter()"> Dividendos A√ß√µes
            </label>
            <label class="multiselect-option">
              <input type="checkbox" value="divFIIs" checked onchange="updateAnualFilter()"> Dividendos FIIs
            </label>
          </div>
        </div>
      </div>
    </div>
    <div class="chart-container"><canvas id="cAnual"></canvas></div>
  </div>

  <!-- Chart: Evolu√ß√£o Mensal -->
  <div class="card">
    <div class="card-header">
      <div class="card-title"><span>üìà</span> Evolu√ß√£o Mensal</div>
      <div class="controls">
        <div class="multiselect-wrapper">
          <button id="filterMensalBtn" class="filter-select" onclick="toggleMensalFilter(event)">
            <span id="filterMensalLabel">Todas as Fontes</span> ‚ñæ
          </button>
          <div id="filterMensalDropdown" class="multiselect-dropdown" style="display: none;">
            <label class="multiselect-option">
              <input type="checkbox" value="all" checked onchange="toggleAllMensal(this)"> Todas
            </label>
            <label class="multiselect-option">
              <input type="checkbox" value="salario" checked onchange="updateMensalFilter()"> Sal√°rio
            </label>
            <label class="multiselect-option">
              <input type="checkbox" value="outras" checked onchange="updateMensalFilter()"> Outras Receitas
            </label>
            <label class="multiselect-option">
              <input type="checkbox" value="divAcoes" checked onchange="updateMensalFilter()"> Dividendos A√ß√µes
            </label>
            <label class="multiselect-option">
              <input type="checkbox" value="divFIIs" checked onchange="updateMensalFilter()"> Dividendos FIIs
            </label>
          </div>
        </div>
        <div style="display: flex; gap: 4px;">
          <button class="btn-period active" onclick="setPeriodMensal('12m', this)">12M</button>
          <button class="btn-period" onclick="setPeriodMensal('24m', this)">24M</button>
          <button class="btn-period" onclick="setPeriodMensal('36m', this)">36M</button>
          <button class="btn-period" onclick="setPeriodMensal('todos', this)">Todos</button>
        </div>
      </div>
    </div>
    <div class="chart-container"><canvas id="cMensal"></canvas></div>
  </div>

  <!-- Chart: Donut -->
  <div class="card">
    <div class="card-header">
      <div class="card-title"><span>ü•ß</span> % por Subcategoria (12M)</div>
    </div>
    <div class="chart-container"><canvas id="cDonut"></canvas></div>
  </div>

  <!-- Chart: Taxa de Poupan√ßa -->
  <div class="card">
    <div class="card-header">
      <div class="card-title"><span>üí∞</span> Taxa de Poupan√ßa por Ano</div>
    </div>
    <div class="chart-container"><canvas id="cTaxaAnual"></canvas></div>
  </div>
</main>

<script>
// Desabilitar datalabels globalmente
Chart.defaults.set('plugins.datalabels', { display: false });

// ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ
const COLORS = {
  salario: '#48bb78',
  outras: '#667eea',
  divAcoes: '#e74c3c',
  divFIIs: '#f39c12'
};

const LABELS = {
  salario: 'Sal√°rio',
  outras: 'Outras Receitas',
  divAcoes: 'Dividendos A√ß√µes',
  divFIIs: 'Dividendos FIIs'
};

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
let allData = {
  salario: [],
  outrasReceitas: [],
  dividendosAcoes: [],
  dividendosFIIs: [],
  despesas: []
};
let filteredData12M = {}; // Para KPIs e Donut (fixo 12M)
let filteredDataMensal = {}; // Para gr√°fico mensal (vari√°vel)
let currentPeriodMensal = '12m';
let charts = {};
let tickerClassMap = {};

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ
function brl(v) {
  return 'R$ ' + v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function compactFmt(n) {
  return Intl.NumberFormat('pt-BR', { notation: "compact", compactDisplay: "short" }).format(n);
}

function monthLabel(key) {
  const [y, m] = key.split('-');
  return new Date(parseInt(y), parseInt(m) - 1, 1)
    .toLocaleString('pt-BR', { month: 'short', year: '2-digit' })
    .replace('.', '');
}

function somaValores(arr) {
  return arr.reduce((sum, r) => sum + Math.abs(r.valor || r.valor_total || 0), 0);
}

function mesesUnicos(arr) {
  return [...new Set(arr.map(r => r.data.substring(0, 7)))].length;
}

function anosUnicos(arr) {
  return [...new Set(arr.map(r => r.data.substring(0, 4)))].sort();
}

// ‚îÄ‚îÄ‚îÄ THEME ‚îÄ‚îÄ‚îÄ
function updateMetaThemeColor(isDark) {
  const color = isDark ? '#1a202c' : '#f7fafc';
  const scheme = isDark ? 'only dark' : 'only light';
  
  let metaTheme = document.querySelector('meta[name="theme-color"]');
  if (!metaTheme) {
    metaTheme = document.createElement('meta');
    metaTheme.name = 'theme-color';
    document.head.appendChild(metaTheme);
  }
  metaTheme.content = color;

  let metaScheme = document.querySelector('meta[name="color-scheme"]');
  if (!metaScheme) {
    metaScheme = document.createElement('meta');
    metaScheme.name = 'color-scheme';
    document.head.appendChild(metaScheme);
  }
  metaScheme.content = scheme;
}

function initTheme() {
  const savedTheme = localStorage.getItem('theme');
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  
  let isDark = false;
  if (savedTheme === 'dark') {
    isDark = true;
  } else if (savedTheme === 'light') {
    isDark = false;
  } else if (prefersDark) {
    isDark = true;
  }
  
  if (isDark) {
    document.body.classList.add('dark-mode');
    document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è';
  } else {
    document.body.classList.remove('dark-mode');
    document.getElementById('theme-toggle').textContent = 'üåô';
  }
  updateMetaThemeColor(isDark);
}

function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  const isDark = document.body.classList.contains('dark-mode');
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
  document.getElementById('theme-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  updateMetaThemeColor(isDark);
  setTimeout(renderAll, 50);
}

// ‚îÄ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ‚îÄ
function setPeriodMensal(period, btn) {
  currentPeriodMensal = period;
  const parent = btn.parentElement;
  parent.querySelectorAll('.btn-period').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  applyFilterMensal();
  renderMensal();
}

function applyFilter12M() {
  const combinedReceitas = [
    ...allData.salario,
    ...allData.outrasReceitas,
    ...allData.dividendosAcoes,
    ...allData.dividendosFIIs
  ];
  
  if (!combinedReceitas.length) {
    filteredData12M = { salario: [], outrasReceitas: [], dividendosAcoes: [], dividendosFIIs: [], despesas: [] };
    return;
  }

  const lastKey = combinedReceitas.reduce((max, r) => r.data > max ? r.data : max, '');
  const refDate = lastKey ? new Date(lastKey + 'T00:00') : new Date();
  
  // Sempre 12 meses para KPIs e Donut
  const cutoff = new Date(refDate.getFullYear(), refDate.getMonth() - 11, 1);
  const cutKey = `${cutoff.getFullYear()}-${String(cutoff.getMonth() + 1).padStart(2, '0')}`;

  filteredData12M = {
    salario: allData.salario.filter(r => r.data.substring(0, 7) >= cutKey),
    outrasReceitas: allData.outrasReceitas.filter(r => r.data.substring(0, 7) >= cutKey),
    dividendosAcoes: allData.dividendosAcoes.filter(r => r.data.substring(0, 7) >= cutKey),
    dividendosFIIs: allData.dividendosFIIs.filter(r => r.data.substring(0, 7) >= cutKey),
    despesas: allData.despesas.filter(r => r.data.substring(0, 7) >= cutKey)
  };
}

function applyFilterMensal() {
  const combinedReceitas = [
    ...allData.salario,
    ...allData.outrasReceitas,
    ...allData.dividendosAcoes,
    ...allData.dividendosFIIs
  ];
  
  if (!combinedReceitas.length) {
    filteredDataMensal = { salario: [], outrasReceitas: [], dividendosAcoes: [], dividendosFIIs: [], despesas: [] };
    return;
  }

  const lastKey = combinedReceitas.reduce((max, r) => r.data > max ? r.data : max, '');
  const refDate = lastKey ? new Date(lastKey + 'T00:00') : new Date();

  let cutKey = '';
  if (currentPeriodMensal === 'todos') {
    cutKey = '0000-00';
  } else {
    const months = parseInt(currentPeriodMensal);
    const cutoff = new Date(refDate.getFullYear(), refDate.getMonth() - months + 1, 1);
    cutKey = `${cutoff.getFullYear()}-${String(cutoff.getMonth() + 1).padStart(2, '0')}`;
  }

  filteredDataMensal = {
    salario: allData.salario.filter(r => r.data.substring(0, 7) >= cutKey),
    outrasReceitas: allData.outrasReceitas.filter(r => r.data.substring(0, 7) >= cutKey),
    dividendosAcoes: allData.dividendosAcoes.filter(r => r.data.substring(0, 7) >= cutKey),
    dividendosFIIs: allData.dividendosFIIs.filter(r => r.data.substring(0, 7) >= cutKey),
    despesas: allData.despesas.filter(r => r.data.substring(0, 7) >= cutKey)
  };
}

// ‚îÄ‚îÄ‚îÄ MULTI-SELECT ANUAL ‚îÄ‚îÄ‚îÄ
function toggleAnualFilter(event) {
  event.stopPropagation();
  const dropdown = document.getElementById('filterAnualDropdown');
  dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

function toggleAllAnual(checkbox) {
  const checkboxes = document.querySelectorAll('#filterAnualDropdown input[type="checkbox"]:not([value="all"])');
  checkboxes.forEach(cb => cb.checked = checkbox.checked);
  updateAnualFilter();
}

function updateAnualFilter() {
  const checkboxes = document.querySelectorAll('#filterAnualDropdown input[type="checkbox"]:not([value="all"])');
  const allCheckbox = document.querySelector('#filterAnualDropdown input[value="all"]');
  const selected = Array.from(checkboxes).filter(cb => cb.checked);
  
  allCheckbox.checked = selected.length === checkboxes.length;
  
  const label = document.getElementById('filterAnualLabel');
  if (selected.length === 0 || selected.length === checkboxes.length) {
    label.textContent = 'Todas as Fontes';
  } else if (selected.length === 1) {
    label.textContent = LABELS[selected[0].value];
  } else {
    label.textContent = `${selected.length} selecionadas`;
  }
  
  renderAnual();
}

// ‚îÄ‚îÄ‚îÄ MULTI-SELECT MENSAL ‚îÄ‚îÄ‚îÄ
function toggleMensalFilter(event) {
  event.stopPropagation();
  const dropdown = document.getElementById('filterMensalDropdown');
  dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

function toggleAllMensal(checkbox) {
  const checkboxes = document.querySelectorAll('#filterMensalDropdown input[type="checkbox"]:not([value="all"])');
  checkboxes.forEach(cb => cb.checked = checkbox.checked);
  updateMensalFilter();
}

function updateMensalFilter() {
  const checkboxes = document.querySelectorAll('#filterMensalDropdown input[type="checkbox"]:not([value="all"])');
  const allCheckbox = document.querySelector('#filterMensalDropdown input[value="all"]');
  const selected = Array.from(checkboxes).filter(cb => cb.checked);
  
  allCheckbox.checked = selected.length === checkboxes.length;
  
  const label = document.getElementById('filterMensalLabel');
  if (selected.length === 0 || selected.length === checkboxes.length) {
    label.textContent = 'Todas as Fontes';
  } else if (selected.length === 1) {
    label.textContent = LABELS[selected[0].value];
  } else {
    label.textContent = `${selected.length} selecionadas`;
  }
  
  renderMensal();
}

// Fechar dropdowns ao clicar fora
document.addEventListener('click', () => {
  document.querySelectorAll('.multiselect-dropdown').forEach(d => d.style.display = 'none');
});

// ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ
function renderAll() {
  updateKPIs();
  renderAnual();
  renderMensal();
  renderDonut();
  renderTaxaAnual();
}

function updateKPIs() {
  // KPIs sempre baseados em 12M
  const totalSalario = somaValores(filteredData12M.salario);
  const totalOutras = somaValores(filteredData12M.outrasReceitas);
  const totalDivAcoes = somaValores(filteredData12M.dividendosAcoes);
  const totalDivFIIs = somaValores(filteredData12M.dividendosFIIs);
  const totalReceitas = totalSalario + totalOutras + totalDivAcoes + totalDivFIIs;
  const totalDespesas = somaValores(filteredData12M.despesas);
  
  const allReceitas = [
    ...filteredData12M.salario,
    ...filteredData12M.outrasReceitas,
    ...filteredData12M.dividendosAcoes,
    ...filteredData12M.dividendosFIIs
  ];
  const meses = mesesUnicos(allReceitas) || 1;
  
  const mediaTotal = totalReceitas / meses;
  const mediaPassiva = (totalOutras + totalDivAcoes + totalDivFIIs) / meses;
  const taxaPoupanca = totalReceitas > 0 ? ((totalReceitas - totalDespesas) / totalReceitas) * 100 : 0;
  
  document.getElementById('kpiTotal').textContent = brl(totalReceitas);
  document.getElementById('kpiMedia').textContent = brl(mediaTotal);
  document.getElementById('kpiTaxa').textContent = taxaPoupanca.toFixed(1) + '%';
  document.getElementById('kpiPassiva').textContent = brl(mediaPassiva);
}

function renderAnual() {
  const ctx = document.getElementById('cAnual').getContext('2d');
  const textColor = getComputedStyle(document.body).getPropertyValue('--text').trim();
  const gridColor = getComputedStyle(document.body).getPropertyValue('--border').trim();
  
  const checkboxes = document.querySelectorAll('#filterAnualDropdown input[type="checkbox"]:not([value="all"]):checked');
  const active = Array.from(checkboxes).map(cb => cb.value);
  
  // Usar todos os dados (sem filtro temporal)
  const allYears = anosUnicos([
    ...allData.salario,
    ...allData.outrasReceitas,
    ...allData.dividendosAcoes,
    ...allData.dividendosFIIs
  ]);
  
  const datasets = [];
  
  if (active.includes('salario')) {
    const data = allYears.map(y => somaValores(allData.salario.filter(r => r.data.substring(0, 4) === y)));
    datasets.push({ label: LABELS.salario, data, backgroundColor: COLORS.salario, borderRadius: 4 });
  }
  if (active.includes('outras')) {
    const data = allYears.map(y => somaValores(allData.outrasReceitas.filter(r => r.data.substring(0, 4) === y)));
    datasets.push({ label: LABELS.outras, data, backgroundColor: COLORS.outras, borderRadius: 4 });
  }
  if (active.includes('divAcoes')) {
    const data = allYears.map(y => somaValores(allData.dividendosAcoes.filter(r => r.data.substring(0, 4) === y)));
    datasets.push({ label: LABELS.divAcoes, data, backgroundColor: COLORS.divAcoes, borderRadius: 4 });
  }
  if (active.includes('divFIIs')) {
    const data = allYears.map(y => somaValores(allData.dividendosFIIs.filter(r => r.data.substring(0, 4) === y)));
    datasets.push({ label: LABELS.divFIIs, data, backgroundColor: COLORS.divFIIs, borderRadius: 4 });
  }
  
  if (charts.anual) charts.anual.destroy();
  charts.anual = new Chart(ctx, {
    type: 'bar',
    data: { labels: allYears, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { stacked: true, grid: { display: false }, ticks: { color: textColor } },
        y: { 
          stacked: true, 
          ticks: { callback: v => compactFmt(v), color: textColor },
          grid: { color: gridColor }
        }
      },
      plugins: {
        legend: { 
          position: 'bottom', 
          labels: { boxWidth: 12, font: { size: 10 }, color: textColor } 
        },
        tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + brl(ctx.raw) } }
      }
    }
  });
}

function renderMensal() {
  const ctx = document.getElementById('cMensal').getContext('2d');
  const textColor = getComputedStyle(document.body).getPropertyValue('--text').trim();
  const gridColor = getComputedStyle(document.body).getPropertyValue('--border').trim();
  
  const checkboxes = document.querySelectorAll('#filterMensalDropdown input[type="checkbox"]:not([value="all"]):checked');
  const active = Array.from(checkboxes).map(cb => cb.value);
  
  // Usar dados filtrados pelo per√≠odo selecionado
  const allMonths = [...new Set([
    ...filteredDataMensal.salario.map(r => r.data.substring(0, 7)),
    ...filteredDataMensal.outrasReceitas.map(r => r.data.substring(0, 7)),
    ...filteredDataMensal.dividendosAcoes.map(r => r.data.substring(0, 7)),
    ...filteredDataMensal.dividendosFIIs.map(r => r.data.substring(0, 7))
  ])].sort();
  
  const datasets = [];
  
  if (active.includes('salario')) {
    const data = allMonths.map(m => somaValores(filteredDataMensal.salario.filter(r => r.data.substring(0, 7) === m)));
    datasets.push({ label: LABELS.salario, data, backgroundColor: COLORS.salario, borderRadius: 4, stack: 'Stack0' });
  }
  if (active.includes('outras')) {
    const data = allMonths.map(m => somaValores(filteredDataMensal.outrasReceitas.filter(r => r.data.substring(0, 7) === m)));
    datasets.push({ label: LABELS.outras, data, backgroundColor: COLORS.outras, borderRadius: 4, stack: 'Stack0' });
  }
  if (active.includes('divAcoes')) {
    const data = allMonths.map(m => somaValores(filteredDataMensal.dividendosAcoes.filter(r => r.data.substring(0, 7) === m)));
    datasets.push({ label: LABELS.divAcoes, data, backgroundColor: COLORS.divAcoes, borderRadius: 4, stack: 'Stack0' });
  }
  if (active.includes('divFIIs')) {
    const data = allMonths.map(m => somaValores(filteredDataMensal.dividendosFIIs.filter(r => r.data.substring(0, 7) === m)));
    datasets.push({ label: LABELS.divFIIs, data, backgroundColor: COLORS.divFIIs, borderRadius: 4, stack: 'Stack0' });
  }
  
  const labels = allMonths.map(monthLabel);
  
  if (charts.mensal) charts.mensal.destroy();
  charts.mensal = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { 
          stacked: true, 
          grid: { display: false }, 
          ticks: { maxRotation: 45, font: { size: 10 }, color: textColor } 
        },
        y: { 
          stacked: true, 
          ticks: { callback: v => compactFmt(v), color: textColor },
          grid: { color: gridColor }
        }
      },
      plugins: {
        legend: { 
          position: 'bottom', 
          labels: { boxWidth: 12, font: { size: 10 }, color: textColor } 
        }
      }
    }
  });
}

function renderDonut() {
  const ctx = document.getElementById('cDonut').getContext('2d');
  const textColor = getComputedStyle(document.body).getPropertyValue('--text').trim();
  
  // Usar dados de 12M (mesma base dos KPIs)
  const totals = {
    salario: somaValores(filteredData12M.salario),
    outras: somaValores(filteredData12M.outrasReceitas),
    divAcoes: somaValores(filteredData12M.dividendosAcoes),
    divFIIs: somaValores(filteredData12M.dividendosFIIs)
  };
  
  const entries = Object.entries(totals).filter(([k, v]) => v > 0);
  const labels = entries.map(([k]) => LABELS[k]);
  const data = entries.map(([k, v]) => v);
  const colors = entries.map(([k]) => COLORS[k]);
  
  const total = data.reduce((a, b) => a + b, 0);
  
  if (charts.donut) charts.donut.destroy();
  charts.donut = new Chart(ctx, {
    type: 'doughnut',
    data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0 }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '65%',
      plugins: {
        legend: { 
          position: 'right', 
          labels: { boxWidth: 12, font: { size: 10 }, color: textColor } 
        },
        tooltip: {
          callbacks: {
            label: ctx => {
              const pct = ((ctx.parsed / total) * 100).toFixed(1);
              return ` ${brl(ctx.parsed)} (${pct}%)`;
            }
          }
        }
      }
    }
  });
}

function renderTaxaAnual() {
  const ctx = document.getElementById('cTaxaAnual').getContext('2d');
  const textColor = getComputedStyle(document.body).getPropertyValue('--text').trim();
  const gridColor = getComputedStyle(document.body).getPropertyValue('--border').trim();
  
  // Usar todos os dados (sem filtro temporal)
  const allReceitas = [
    ...allData.salario,
    ...allData.outrasReceitas,
    ...allData.dividendosAcoes,
    ...allData.dividendosFIIs
  ];
  const years = anosUnicos([...allReceitas, ...allData.despesas]);
  
  const taxas = years.map(y => {
    const receitasAno = somaValores([
      ...allData.salario.filter(r => r.data.substring(0, 4) === y),
      ...allData.outrasReceitas.filter(r => r.data.substring(0, 4) === y),
      ...allData.dividendosAcoes.filter(r => r.data.substring(0, 4) === y),
      ...allData.dividendosFIIs.filter(r => r.data.substring(0, 4) === y)
    ]);
    const despesasAno = somaValores(allData.despesas.filter(r => r.data.substring(0, 4) === y));
    return receitasAno > 0 ? ((receitasAno - despesasAno) / receitasAno) * 100 : 0;
  });
  
  if (charts.taxaAnual) charts.taxaAnual.destroy();
  charts.taxaAnual = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: years,
      datasets: [{
        label: 'Taxa de Poupan√ßa (%)',
        data: taxas,
        backgroundColor: taxas.map(v => v >= 0 ? '#48bb78' : '#f56565'),
        borderRadius: 4,
        datalabels: {
          display: true,
          anchor: 'end',
          align: 'top',
          offset: 4,
          formatter: v => v.toFixed(1) + '%',
          font: { weight: 'bold', size: 10 },
          color: textColor
        }
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: { top: 25 } },
      scales: {
        y: { 
          ticks: { callback: v => v.toFixed(1) + '%', color: textColor },
          grid: { color: gridColor }
        },
        x: {
          ticks: { color: textColor },
          grid: { display: false }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: ctx => `Taxa: ${ctx.raw.toFixed(1)}%` } }
      }
    },
    plugins: [ChartDataLabels]
  });
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
async function init() {
  initTheme();
  
  try {
    const [lancReq, divReq, ativosReq] = await Promise.all([
      fetch('data/lancamentos.json?v=' + Date.now()),
      fetch('data/dividendos_historico.json?v=' + Date.now()),
      fetch('data/ativos_financeiros.json?v=' + Date.now())
    ]);
    
    const lancData = await lancReq.json();
    const divData = await divReq.json();
    const ativosData = await ativosReq.json();
    
    // Mapear ticker ‚Üí classe
    ativosData.ativos.forEach(a => {
      const ticker = a.nome.split('_')[0];
      tickerClassMap[ticker] = a.macro_classe;
    });
    
    // Processar lan√ßamentos
    const lancamentos = Array.isArray(lancData) ? lancData : (lancData.lancamentos || []);
    const receitas = lancamentos.filter(r => r.categoria === 'receitas');
    
    allData.salario = receitas.filter(r => r.subcategoria === 'Sal√°rio');
    allData.outrasReceitas = receitas.filter(r => r.subcategoria === 'Outras Receitas');
    allData.despesas = lancamentos.filter(r => r.categoria !== 'receitas');
    
    // Processar dividendos
    const dividendos = divData.movimentacoes || [];
    dividendos.forEach(d => {
      if (!['PROVENTO_DIVIDENDO', 'PROVENTO_JCP'].includes(d.tipo)) return;
      
      const ticker = d.ativo.split('_')[0];
      const classe = tickerClassMap[ticker];
      const item = { ...d, valor: d.valor_total };
      
      if (classe === '3_acoes_brasil') {
        allData.dividendosAcoes.push(item);
      } else if (classe === '4_ativos_reais') {
        allData.dividendosFIIs.push(item);
      }
    });
    
    applyFilter12M();
    applyFilterMensal();
    renderAll();
    document.getElementById('loading').classList.add('hidden');
    
  } catch(err) {
    alert('Erro ao carregar dados: ' + err.message);
    console.error(err);
  }
}

init();
</script>
</body>
</html>
