<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dividendos & Proventos - Hub Fam√≠lia</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <style>
    /* === CSS VARIABLES & THEME === */
    :root {
      --bg: #f4f7f6;
      --text: #333;
      --text-muted: #718096;
      --surface: #ffffff;
      --primary: #2c3e50;
      --accent: #3498db;
      --border: #e2e8f0;
      --badge-bg: #ecf0f1;
      --shadow: 0 4px 16px rgba(0,0,0,0.07);
      --radius: 16px;
    }
    body.dark-mode {
      --bg: #1a1a1a;
      --text: #e0e0e0;
      --text-muted: #a0aec0;
      --surface: #2d2d2d;
      --primary: #ecf0f1;
      --border: #4a5568;
      --badge-bg: #3d3d3d;
      --shadow: 0 4px 16px rgba(0,0,0,0.3);
    }

    /* === BASE === */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
      padding: 10px 10px 60px 10px;
    }

    /* === HEADER === */
    .header-bar {
      display: flex; justify-content: space-between; align-items: center;
      max-width: 1280px; margin: 0 auto 20px; padding: 10px;
    }
    h1 { font-size: 1.5rem; font-weight: 800; color: var(--text); margin: 0; }
    .nav-link { color: var(--accent); text-decoration: none; font-weight: 600; font-size: 0.9rem; }
    #theme-toggle { background: none; border: none; font-size: 1.2rem; cursor: pointer; }

    /* === LAYOUT === */
    main { max-width: 1280px; margin: 0 auto; }

    /* === KPI GRID === */
    .kpi-grid {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;
    }
    @media (min-width: 768px) { .kpi-grid { grid-template-columns: repeat(4, 1fr); gap: 15px; } }

    .kpi-card {
      background: var(--surface); border-radius: var(--radius);
      box-shadow: var(--shadow); padding: 15px;
      display: flex; flex-direction: column;
    }
    .kpi-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 5px; }
    .kpi-value { font-size: 1.4rem; font-weight: 800; color: var(--primary); }
    .kpi-sub { font-size: 0.75rem; color: var(--text-muted); margin-top: auto; }

    /* === CHARTS === */
    .charts-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
    @media (min-width: 900px) { .charts-grid { grid-template-columns: 1fr 1fr; } }
    .chart-full { grid-column: 1 / -1; }

    .card {
      background: var(--surface); border-radius: var(--radius);
      box-shadow: var(--shadow); padding: 20px;
    }
    .card-header { 
      display: flex; justify-content: space-between; align-items: center; 
      margin-bottom: 15px; flex-wrap: wrap; gap: 10px;
    }
    .card-title { font-size: 1.1rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 8px; }
    
    .chart-container {
      position: relative; width: 100%; height: 450px;
    }
    @media (max-width: 600px) { .chart-container { height: 380px; } }

    /* === CONTROLS === */
    .controls { display: flex; gap: 8px; align-items: center; }
    select, button.filter-btn {
      background: var(--badge-bg); color: var(--text);
      border: 1px solid var(--border); padding: 6px 12px;
      border-radius: 8px; font-size: 0.85rem; cursor: pointer;
      font-family: inherit;
    }
    button.filter-btn.active {
      background: var(--accent); color: white; border-color: var(--accent);
    }

    /* === LOADING === */
    #loading {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center; z-index: 1000;
      color: white; font-weight: bold; backdrop-filter: blur(4px);
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div id="loading">Carregando dados...</div>

<div class="header-bar">
  <div>
    <a href="index.html" class="nav-link">‚Üê Voltar</a>
    <h1>üìä Dividendos</h1>
  </div>
  <button id="theme-toggle" onclick="toggleTheme()">üåô</button>
</div>

<main>
  <!-- KPIs -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <span class="kpi-label">üí∞ Total Acumulado</span>
      <span class="kpi-value" id="kpiTotal">‚Äî</span>
      <span class="kpi-sub">Hist√≥rico completo</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-label">üìÖ Total YTD</span>
      <span class="kpi-value" id="kpiYTD">‚Äî</span>
      <span class="kpi-sub" id="kpiYTDLabel">Ano atual</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-label">üìà M√©dia Mensal (12M)</span>
      <span class="kpi-value" id="kpiAvg">‚Äî</span>
      <span class="kpi-sub">√öltimos 12 meses</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-label">üöÄ CAGR (5 Anos)</span>
      <span class="kpi-value" id="kpiCAGR">‚Äî</span>
      <span class="kpi-sub">Crescimento anual</span>
    </div>
  </div>

  <!-- Charts -->
  <div class="charts-grid">
    <!-- Chart 1: Anual -->
    <div class="card chart-full">
      <div class="card-header">
        <div class="card-title"><span>üìä</span> Evolu√ß√£o Anual</div>
        <div class="controls">
          <!-- Filtro de Classes (Opcional, implementado visualmente) -->
          <select id="filterClass" onchange="updateCharts()">
            <option value="all">Todas as Classes</option>
          </select>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="chartAnual"></canvas>
      </div>
    </div>

    <!-- Chart 2: Mensal -->
    <div class="card chart-full">
      <div class="card-header">
        <div class="card-title"><span>üóìÔ∏è</span> Evolu√ß√£o Mensal</div>
        <div class="controls">
          <button class="filter-btn active" onclick="setMonthRange(12, this)">12M</button>
          <button class="filter-btn" onclick="setMonthRange(24, this)">24M</button>
          <button class="filter-btn" onclick="setMonthRange(36, this)">36M</button>
          <button class="filter-btn" onclick="setMonthRange(999, this)">Todos</button>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="chartMensal"></canvas>
      </div>
    </div>

    <!-- Chart 3: Donut -->
    <div class="card">
      <div class="card-header">
        <div class="card-title"><span>ü•ß</span> Composi√ß√£o por Classe</div>
        <div class="controls">
          <button class="filter-btn active" onclick="setDonutRange(12, this)">12M</button>
          <button class="filter-btn" onclick="setDonutRange(24, this)">24M</button>
          <button class="filter-btn" onclick="setDonutRange(36, this)">36M</button>
          <button class="filter-btn" onclick="setDonutRange(999, this)">Todos</button>
        </div>
      </div>
      <div class="chart-container" style="height: 400px;">
        <canvas id="chartDonut"></canvas>
      </div>
    </div>
    
    <!-- Chart 4: Top Pagadores -->
    <div class="card">
      <div class="card-header">
        <div class="card-title"><span>üèÜ</span> Top Pagadores (12M)</div>
      </div>
      <div class="chart-container" style="height: 300px;">
        <canvas id="chartTop"></canvas>
      </div>
    </div>
  </div>
</main>

<script>
// === CONFIG ===
const COLORS = {
  '1_renda_fixa_soberana': '#3498db',
  '2_credito_privado': '#2ecc71', 
  '3_acoes_brasil': '#e74c3c',
  '4_ativos_reais': '#f39c12',
  '5_internacional': '#9b59b6',
  '6_criptoativos': '#1abc9c',
  '7_alternativos_estratega': '#e67e22',
  'default': '#95a5a6'
};

const LABELS = {
  '1_renda_fixa_soberana': 'Renda Fixa',
  '2_credito_privado': 'Cr√©dito',
  '3_acoes_brasil': 'A√ß√µes BR',
  '4_ativos_reais': 'FIIs/Im√≥veis',
  '5_internacional': 'Exterior',
  '6_criptoativos': 'Cripto',
  '7_alternativos_estratega': 'Alternativos'
};

// === STATE ===
let rawData = [];
let monthLimit = 12;
let donutLimit = 12;
let charts = {};

// === INIT ===
async function init() {
  try {
    const [divReq, ativosReq] = await Promise.all([
      fetch('data/dividendos_historico.json'),
      fetch('data/ativos_financeiros.json')
    ]);
    
    const divData = await divReq.json();
    const ativosData = await ativosReq.json();
    
    // Mapear Ticker -> Classe
    const tickerMap = {};
    ativosData.ativos.forEach(a => {
      const t = a.nome.split('_')[0];
      tickerMap[t] = a.macro_classe;
    });

    // Processar Dados
    rawData = divData.movimentacoes.map(m => {
      const ticker = m.ativo.split('_')[0];
      return {
        date: new Date(m.data), // YYYY-MM-DD funciona no construtor Date
        year: m.data.substring(0, 4),
        month: m.data.substring(0, 7), // YYYY-MM
        val: m.valor_total || 0,
        class: tickerMap[ticker] || 'Outros',
        ticker: ticker
      };
    }).sort((a,b) => a.date - b.date);

    // Popular Filtro de Classes
    const uniqueClasses = [...new Set(rawData.map(d => d.class))].sort();
    const select = document.getElementById('filterClass');
    uniqueClasses.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = LABELS[c] || c;
      select.appendChild(opt);
    });

    renderAll();
    document.getElementById('loading').classList.add('hidden');

  } catch (e) {
    alert('Erro ao carregar dados: ' + e.message);
    console.error(e);
  }
}

function renderAll() {
  updateKPIs();
  renderAnual();
  renderMensal();
  renderDonut();
  renderTop();
}

// === KPIS ===
function updateKPIs() {
  const total = rawData.reduce((s, d) => s + d.val, 0);
  const now = new Date();
  const currentYear = now.getFullYear().toString();
  
  const ytd = rawData.filter(d => d.year === currentYear).reduce((s, d) => s + d.val, 0);
  
  const oneYearAgo = new Date();
  oneYearAgo.setMonth(now.getMonth() - 12);
  const l12mTotal = rawData.filter(d => d.date >= oneYearAgo).reduce((s, d) => s + d.val, 0);
  
  // CAGR simplificado (Total 5 anos atr√°s vs Total ano passado)
  // Pegar ano completo anterior
  const lastFullYear = currentYear - 1;
  const startYear = lastFullYear - 4; // 5 anos de janela
  
  const endVal = rawData.filter(d => d.year == lastFullYear).reduce((s,d) => s+d.val, 0);
  const startVal = rawData.filter(d => d.year == startYear).reduce((s,d) => s+d.val, 0);
  
  let cagr = 0;
  if (startVal > 0 && endVal > 0) {
    cagr = (Math.pow(endVal / startVal, 1/4) - 1) * 100;
  }

  setTxt('kpiTotal', fmt(total));
  setTxt('kpiYTD', fmt(ytd));
  setTxt('kpiAvg', fmt(l12mTotal / 12));
  setTxt('kpiCAGR', cagr.toFixed(1) + '%');
  setTxt('kpiYTDLabel', `Em ${currentYear}`);
}

// === CHARTS ===
function renderAnual() {
  const ctx = getCtx('chartAnual');
  const years = [...new Set(rawData.map(d => d.year))].sort();
  const classes = [...new Set(rawData.map(d => d.class))];
  
  // Filtrar classe se selecionada
  const selectedClass = document.getElementById('filterClass').value;
  const activeClasses = selectedClass === 'all' ? classes : [selectedClass];

  const datasets = activeClasses.map(c => ({
    label: LABELS[c] || c,
    data: years.map(y => {
      return rawData.filter(d => d.year === y && d.class === c).reduce((s,d) => s+d.val, 0);
    }),
    backgroundColor: COLORS[c] || getColorHash(c),
    borderRadius: 4
  }));

  if (charts.anual) charts.anual.destroy();
  charts.anual = new Chart(ctx, {
    type: 'bar',
    data: { labels: years, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { stacked: true, grid: { display: false } },
        y: { stacked: true, ticks: { callback: v => compactFmt(v) } }
      },
      plugins: {
        tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + fmt(ctx.raw) } }
      }
    }
  });
}

function renderMensal() {
  const ctx = getCtx('chartMensal');
  
  // Pegar √∫ltimos N meses
  // Agrupar rawData por month
  const monthlyData = {};
  rawData.forEach(d => {
    if (!monthlyData[d.month]) monthlyData[d.month] = {};
    if (!monthlyData[d.month][d.class]) monthlyData[d.month][d.class] = 0;
    monthlyData[d.month][d.class] += d.val;
  });

  let months = Object.keys(monthlyData).sort();
  if (monthLimit !== 999) {
    months = months.slice(-monthLimit);
  }

  const classes = [...new Set(rawData.map(d => d.class))];
  const datasets = classes.map(c => ({
    label: LABELS[c] || c,
    data: months.map(m => monthlyData[m][c] || 0),
    backgroundColor: COLORS[c] || getColorHash(c),
    stack: 'Stack 0',
    barPercentage: 0.8,
    categoryPercentage: 0.9
  }));

  if (charts.mensal) charts.mensal.destroy();
  charts.mensal = new Chart(ctx, {
    type: 'bar',
    data: { labels: months, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      scales: {
        x: { stacked: true, grid: { display: false } },
        y: { stacked: true, ticks: { callback: v => compactFmt(v) } }
      }
    }
  });
}

function renderDonut() {
  const ctx = getCtx('chartDonut');
  
  // Filtrar por per√≠odo (igual ao gr√°fico mensal)
  let filteredData = rawData;
  if (donutLimit !== 999) {
    const now = new Date();
    const limitDate = new Date();
    limitDate.setMonth(now.getMonth() - donutLimit);
    filteredData = rawData.filter(d => d.date >= limitDate);
  }
  
  const classes = [...new Set(filteredData.map(d => d.class))];
  const data = classes.map(c => filteredData.filter(d => d.class === c).reduce((s,d)=>s+d.val, 0));

  if (charts.donut) charts.donut.destroy();
  charts.donut = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: classes.map(c => LABELS[c] || c),
      datasets: [{
        data: data,
        backgroundColor: classes.map(c => COLORS[c] || getColorHash(c)),
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '65%',
      plugins: {
        legend: { position: 'right', labels: { boxWidth: 12 } }
      }
    }
  });
}

function renderTop() {
  const ctx = getCtx('chartTop');
  const oneYearAgo = new Date();
  oneYearAgo.setMonth(new Date().getMonth() - 12);
  
  const grouped = {};
  rawData.filter(d => d.date >= oneYearAgo).forEach(d => {
    grouped[d.ticker] = (grouped[d.ticker] || 0) + d.val;
  });

  const sorted = Object.entries(grouped).sort((a,b) => b[1] - a[1]).slice(0, 7);
  
  if (charts.top) charts.top.destroy();
  charts.top = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sorted.map(s => s[0]),
      datasets: [{
        label: 'Total 12M',
        data: sorted.map(s => s[1]),
        backgroundColor: '#34495e',
        borderRadius: 4
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } }
    }
  });
}

// === UTILS ===
function setMonthRange(n, btn) {
  monthLimit = n;
  const parent = btn.parentElement;
  parent.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderMensal();
}

function setDonutRange(n, btn) {
  donutLimit = n;
  const parent = btn.parentElement;
  parent.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderDonut();
}

function updateCharts() {
  renderAnual();
}

function fmt(n) { return n.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); }
function compactFmt(n) { return Intl.NumberFormat('pt-BR', { notation: "compact", compactDisplay: "short" }).format(n); }
function setTxt(id, t) { document.getElementById(id).textContent = t; }
function getCtx(id) { return document.getElementById(id).getContext('2d'); }

// Simple hash for consistent colors on unknown classes
function getColorHash(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = str.charCodeAt(i) + ((hash << 5) - hash);
  }
  const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
  return '#' + '00000'.substring(0, 6 - c.length) + c;
}

function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  const isDark = document.body.classList.contains('dark-mode');
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
  document.getElementById('theme-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
}

if (localStorage.getItem('theme') === 'dark') toggleTheme();

init();
</script>
</body>
</html>
