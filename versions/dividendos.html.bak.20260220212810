<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dividendos & Proventos - Hub Fam√≠lia</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <style>
    /* === CSS VARIABLES & THEME === */
    :root {
      --bg: #f4f7f6;
      --text: #333;
      --text-muted: #718096;
      --surface: #ffffff;
      --primary: #2c3e50;
      --accent: #3498db;
      --border: #e2e8f0;
      --badge-bg: #ecf0f1;
      --badge-text: #7f8c8d;
      --shadow: 0 4px 16px rgba(0,0,0,0.07);
      --shadow-hover: 0 10px 28px rgba(0,0,0,0.13);
      --radius: 16px;
      --radius-sm: 8px;
    }
    body.dark-mode {
      --bg: #1a1a1a;
      --text: #e0e0e0;
      --text-muted: #a0aec0;
      --surface: #2d2d2d;
      --primary: #ecf0f1;
      --accent: #3498db;
      --border: #4a5568;
      --badge-bg: #3d3d3d;
      --badge-text: #bdc3c7;
      --shadow: 0 4px 16px rgba(0,0,0,0.3);
      --shadow-hover: 0 10px 28px rgba(0,0,0,0.4);
    }

    /* === RESET & BASE === */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
      min-height: 100vh;
    }

    /* === NAVBAR === */
    nav {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow);
    }
    .nav-left { display: flex; align-items: center; gap: 0.75rem; }
    .btn-back {
      background: none;
      border: 1.5px solid var(--border);
      color: var(--text);
      padding: 0.4rem 0.85rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn-back:hover { background: var(--accent); color: #fff; border-color: var(--accent); }
    .nav-title { font-size: 1.1rem; font-weight: 700; color: var(--primary); }
    .nav-title span { font-weight: 300; }
    #themeToggle {
      background: var(--badge-bg);
      border: none;
      font-size: 1.1rem;
      cursor: pointer;
      padding: 0.4rem 0.6rem;
      border-radius: 50%;
      line-height: 1;
      transition: background 0.2s;
    }
    #themeToggle:hover { background: var(--border); }

    /* === MAIN LAYOUT === */
    main {
      max-width: 1280px;
      margin: 0 auto;
      padding: 1.5rem 1.25rem 3rem;
    }

    /* === LOADING OVERLAY === */
    #loadingOverlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.45);
      display: flex; align-items: center; justify-content: center;
      z-index: 999;
      flex-direction: column; gap: 1rem;
    }
    #loadingOverlay.hidden { display: none; }
    .spinner {
      width: 44px; height: 44px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #loadingOverlay p { color: #fff; font-weight: 600; font-size: 1rem; }

    /* === CARDS === */
    .card {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.4rem 1.5rem;
      transition: box-shadow 0.2s;
    }
    .card:hover { box-shadow: var(--shadow-hover); }
    .card-header {
      display: flex; align-items: center; gap: 0.6rem;
      margin-bottom: 1rem;
    }
    .card-icon { font-size: 1.4rem; line-height: 1; }
    .card-header h3 {
      font-size: 1rem; font-weight: 700;
      color: var(--primary); margin: 0;
    }

    /* === KPI GRID ===
       Mobile-first: 2 per row always, 4 per row on desktop */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    @media (min-width: 768px) {
      .kpi-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
      }
    }

    .kpi-card {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1rem 1.1rem;
      display: flex; flex-direction: column; gap: 0.3rem;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    @media (min-width: 768px) {
      .kpi-card { padding: 1.25rem 1.4rem; gap: 0.35rem; }
    }
    .kpi-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); }
    .kpi-label {
      font-size: 0.7rem; font-weight: 600;
      color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;
    }
    @media (min-width: 768px) { .kpi-label { font-size: 0.75rem; } }
    .kpi-value {
      font-size: 1.25rem; font-weight: 800;
      color: var(--primary); line-height: 1.1;
    }
    @media (min-width: 768px) { .kpi-value { font-size: 1.65rem; } }
    .kpi-sub { font-size: 0.72rem; color: var(--text-muted); }
    .kpi-icon { font-size: 1.4rem; margin-bottom: 0.15rem; }
    @media (min-width: 768px) { .kpi-icon { font-size: 1.6rem; margin-bottom: 0.25rem; } }

    /* === CHARTS GRID === */
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.25rem;
      margin-bottom: 1.5rem;
    }
    @media (min-width: 900px) {
      .charts-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .chart-card-full { grid-column: 1 / -1; }

    .chart-wrap {
      position: relative;
      width: 100%;
      min-height: 240px;
      max-height: 420px;
      overflow-x: auto;
    }
    .chart-wrap canvas {
      max-height: 400px;
      min-width: 0;
      width: 100% !important;
    }
    @media (max-width: 600px) {
      .chart-wrap { min-height: 200px; max-height: 300px; }
      .chart-wrap canvas { max-height: 280px; }
    }

    /* Monthly chart filter tabs */
    .tab-group {
      display: flex; gap: 0.4rem; margin-bottom: 1rem;
    }
    .tab-btn {
      background: var(--badge-bg); border: none;
      color: var(--text-muted); padding: 0.3rem 0.8rem;
      border-radius: 9999px; cursor: pointer;
      font-size: 0.8rem; font-weight: 600;
      transition: all 0.2s;
      min-height: 36px; min-width: 44px; /* touch-friendly */
    }
    .tab-btn.active {
      background: var(--accent); color: #fff;
    }
    .tab-btn:hover:not(.active) { background: var(--border); }

    /* Macro class color dots */
    .class-dot {
      width: 10px; height: 10px; border-radius: 50%;
      display: inline-block; flex-shrink: 0;
    }

    /* === RESPONSIVE FIXES === */
    @media (max-width: 600px) {
      main { padding: 1rem 0.75rem 2.5rem; }
      nav { padding: 0.6rem 1rem; }
      .nav-title { font-size: 0.95rem; }
    }
  </style>
</head>
<body>

<!-- Loading Overlay -->
<div id="loadingOverlay">
  <div class="spinner"></div>
  <p>Carregando proventos‚Ä¶</p>
</div>

<!-- Navbar -->
<nav>
  <div class="nav-left">
    <a href="index.html" class="btn-back">‚Üê Hub</a>
    <span class="nav-title">üìä <span>Dividendos &amp;</span> Proventos</span>
  </div>
  <button id="themeToggle" onclick="toggleTheme()">üåô</button>
</nav>

<main>
  <!-- KPI Row: 2 per row mobile, 4 per row desktop -->
  <div class="kpi-grid" id="kpiGrid">
    <div class="kpi-card">
      <span class="kpi-icon">üí∞</span>
      <span class="kpi-label">Total Acumulado</span>
      <span class="kpi-value" id="kpiTotal">‚Äî</span>
      <span class="kpi-sub">hist√≥rico completo</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-icon">üìÖ</span>
      <span class="kpi-label">Total YTD</span>
      <span class="kpi-value" id="kpiYTD">‚Äî</span>
      <span class="kpi-sub" id="kpiYTDSub">ano atual</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-icon">üìà</span>
      <span class="kpi-label">M√©dia Mensal L12M</span>
      <span class="kpi-value" id="kpiL12M">‚Äî</span>
      <span class="kpi-sub">√∫ltimos 12 meses</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-icon">üöÄ</span>
      <span class="kpi-label">CAGR 5 Anos</span>
      <span class="kpi-value" id="kpiCAGR">‚Äî</span>
      <span class="kpi-sub">crescimento anual composto</span>
    </div>
  </div>

  <!-- Charts: Anual (full width) + Mensal + Donut -->
  <div class="charts-grid">
    <!-- Evolu√ß√£o Anual: full row -->
    <div class="card chart-card-full">
      <div class="card-header">
        <span class="card-icon">üìä</span>
        <h3>Evolu√ß√£o Anual por Classe</h3>
      </div>
      <div class="chart-wrap">
        <canvas id="chartAnual"></canvas>
      </div>
    </div>

    <!-- Evolu√ß√£o Mensal -->
    <div class="card">
      <div class="card-header">
        <span class="card-icon">üóìÔ∏è</span>
        <h3>Evolu√ß√£o Mensal por Classe</h3>
      </div>
      <div class="tab-group">
        <button class="tab-btn active" onclick="setMonthRange(12, this)">12M</button>
        <button class="tab-btn" onclick="setMonthRange(24, this)">24M</button>
        <button class="tab-btn" onclick="setMonthRange(36, this)">36M</button>
      </div>
      <div class="chart-wrap">
        <canvas id="chartMensal"></canvas>
      </div>
    </div>

    <!-- Donut -->
    <div class="card">
      <div class="card-header">
        <span class="card-icon">ü•ß</span>
        <h3>Composi√ß√£o por Classe</h3>
      </div>
      <div class="chart-wrap" style="min-height:220px;">
        <canvas id="chartDonut"></canvas>
      </div>
    </div>
  </div>
</main>

<script>
// === SECTION: THEME ===
function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  const isDark = document.body.classList.contains('dark-mode');
  document.getElementById('themeToggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
  refreshChartThemes();
}
if (localStorage.getItem('theme') === 'dark') {
  document.body.classList.add('dark-mode');
  document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
}

// === SECTION: COLOR PALETTE PER CLASS ===
// Colors assigned per macro_classe key ‚Äî DRY, never hardcoded elsewhere
const CLASS_PALETTE = {
  '1_renda_fixa_soberana':    '#3498db',
  '2_credito_privado':        '#2ecc71',
  '3_acoes_brasil':           '#e74c3c',
  '4_ativos_reais':           '#f39c12',
  '5_internacional':          '#9b59b6',
  '6_criptoativos':           '#1abc9c',
  '7_alternativos_estratega': '#e67e22',
  'Indefinido':               '#95a5a6',
};
const CLASS_LABELS = {
  '1_renda_fixa_soberana':    'Renda Fixa Soberana',
  '2_credito_privado':        'Cr√©dito Privado',
  '3_acoes_brasil':           'A√ß√µes Brasil',
  '4_ativos_reais':           'Ativos Reais',
  '5_internacional':          'Internacional',
  '6_criptoativos':           'Criptoativos',
  '7_alternativos_estratega': 'Alternativos',
  'Indefinido':               'Indefinido',
};
function classColor(cls) { return CLASS_PALETTE[cls] || '#95a5a6'; }
function classLabel(cls) { return CLASS_LABELS[cls] || cls; }

// === SECTION: GLOBAL STATE ===
let allMovs = [];        // raw movimentacoes from JSON (all history)
let tickerClassMap = {}; // ticker -> macro_classe (from ativos_financeiros.json)
let allClasses = [];     // sorted list of classes present in dividendos data
let monthRange = 12;

let chartAnual = null, chartMensal = null, chartDonut = null;

// === SECTION: DATA LOADING ===
async function loadData() {
  const [divRes, ativoRes] = await Promise.all([
    fetch('./data/dividendos_historico.json?v=' + Date.now()),
    fetch('./data/ativos_financeiros.json?v=' + Date.now()),
  ]);
  if (!divRes.ok) throw new Error('Falha ao carregar dividendos_historico.json');
  if (!ativoRes.ok) throw new Error('Falha ao carregar ativos_financeiros.json');

  const divData = await divRes.json();
  const ativoData = await ativoRes.json();

  // Build ticker -> macro_classe map (DRY: read from JSON, never hardcoded)
  ativoData.ativos.forEach(a => {
    const ticker = a.nome.split('_')[0];
    tickerClassMap[ticker] = a.macro_classe;
  });

  // Enrich movimentacoes with resolved ticker and class
  allMovs = divData.movimentacoes.map(m => {
    const ticker = m.ativo.split('_')[0];
    const macroClasse = tickerClassMap[ticker] || 'Indefinido';
    return {
      ...m,
      ticker,
      macroClasse,
      valor: m.valor_total ?? m.valor ?? 0,
      year: parseInt(m.data.substring(0, 4)),
      month: parseInt(m.data.substring(5, 7)),
      yearMonth: m.data.substring(0, 7),  // e.g. "2024-03"
    };
  });

  // Derive all unique classes present in the data (sorted for consistency)
  const classSet = new Set(allMovs.map(m => m.macroClasse));
  allClasses = Array.from(classSet).sort();
}

// === SECTION: KPI CALCULATIONS ===
function calcKPIs(movs) {
  const currentYear = new Date().getFullYear();
  const total = movs.reduce((s, m) => s + m.valor, 0);

  const ytd = movs
    .filter(m => m.year === currentYear)
    .reduce((s, m) => s + m.valor, 0);

  // L12M: last 12 calendar months from today
  const now = new Date();
  const l12mStart = new Date(now.getFullYear(), now.getMonth() - 11, 1);
  const l12mTotal = movs
    .filter(m => new Date(m.data) >= l12mStart)
    .reduce((s, m) => s + m.valor, 0);
  const l12mAvg = l12mTotal / 12;

  // CAGR 5 years: compare total of last year vs 5 years prior
  const latestYear = Math.max(...movs.map(m => m.year));
  const byYear = {};
  movs.forEach(m => { byYear[m.year] = (byYear[m.year] || 0) + m.valor; });
  const v5 = byYear[latestYear - 5] || null;
  const vN = byYear[latestYear]     || null;
  let cagrStr = '‚Äî';
  if (v5 && vN && v5 > 0) {
    const cagr = Math.pow(vN / v5, 1 / 5) - 1;
    cagrStr = (cagr * 100).toFixed(1) + '%';
  }

  return { total, ytd, l12mAvg, cagrStr, currentYear };
}

function fmtBRL(value) {
  return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits: 0 });
}

function updateKPIs() {
  const { total, ytd, l12mAvg, cagrStr, currentYear } = calcKPIs(allMovs);
  document.getElementById('kpiTotal').textContent  = fmtBRL(total);
  document.getElementById('kpiYTD').textContent    = fmtBRL(ytd);
  document.getElementById('kpiYTDSub').textContent = `ano ${currentYear}`;
  document.getElementById('kpiL12M').textContent   = fmtBRL(l12mAvg);
  document.getElementById('kpiCAGR').textContent   = cagrStr;
}

// === SECTION: CHART HELPERS ===
function isDark() { return document.body.classList.contains('dark-mode'); }
function gridColor() { return isDark() ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.07)'; }
function tickColor() { return isDark() ? '#cbd5e0' : '#718096'; }

function chartDefaults() {
  return {
    responsive: true,
    maintainAspectRatio: true,
    animation: { duration: 400 },
    plugins: {
      legend: {
        labels: { color: tickColor(), font: { size: 11 }, boxWidth: 12 },
        position: 'bottom',
      },
      tooltip: {
        callbacks: {
          label: ctx => ` ${ctx.dataset.label}: ${fmtBRL(ctx.raw || 0)}`
        }
      }
    },
    scales: {
      x: {
        stacked: true,
        ticks: { color: tickColor(), font: { size: 11 } },
        grid: { color: gridColor() },
      },
      y: {
        stacked: true,
        ticks: {
          color: tickColor(), font: { size: 11 },
          callback: v => fmtBRL(v),
        },
        grid: { color: gridColor() },
      }
    }
  };
}

// Aggregate: sum values grouped by a key per class
function aggregateByKeyAndClass(movs, keyFn) {
  const map = {};  // key -> { class: value }
  movs.forEach(m => {
    const k = keyFn(m);
    if (!map[k]) map[k] = {};
    map[k][m.macroClasse] = (map[k][m.macroClasse] || 0) + m.valor;
  });
  return map;
}

// === SECTION: CHART ‚Äî ANUAL ===
function buildAnualChart(movs) {
  const years = [];
  const minYear = Math.min(...movs.map(m => m.year));
  const maxYear = Math.max(...movs.map(m => m.year));
  for (let y = minYear; y <= maxYear; y++) years.push(y);

  const agg = aggregateByKeyAndClass(movs, m => m.year);

  const datasets = allClasses.map(cls => ({
    label: classLabel(cls),
    data: years.map(y => agg[y]?.[cls] || 0),
    backgroundColor: classColor(cls),
    borderRadius: 3,
  }));

  const ctx = document.getElementById('chartAnual').getContext('2d');
  if (chartAnual) chartAnual.destroy();

  chartAnual = new Chart(ctx, {
    type: 'bar',
    data: { labels: years.map(String), datasets },
    options: {
      ...chartDefaults(),
      plugins: {
        ...chartDefaults().plugins,
        tooltip: {
          callbacks: {
            label: ctx => ` ${ctx.dataset.label}: ${fmtBRL(ctx.raw || 0)}`,
            footer: items => {
              const total = items.reduce((s, i) => s + (i.raw || 0), 0);
              return `Total: ${fmtBRL(total)}`;
            }
          }
        }
      }
    }
  });
}

// === SECTION: CHART ‚Äî MENSAL ===
function buildMensalChart(movs) {
  // Generate last N months
  const now = new Date();
  const months = [];
  for (let i = monthRange - 1; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const ym = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
    months.push(ym);
  }

  const movsInRange = movs.filter(m => months.includes(m.yearMonth));
  const agg = aggregateByKeyAndClass(movsInRange, m => m.yearMonth);

  const datasets = allClasses.map(cls => ({
    label: classLabel(cls),
    data: months.map(ym => agg[ym]?.[cls] || 0),
    backgroundColor: classColor(cls),
    borderRadius: 2,
  }));

  // Short label for months (e.g. "jan/24")
  const MONTH_NAMES = ['jan','fev','mar','abr','mai','jun','jul','ago','set','out','nov','dez'];
  const labels = months.map(ym => {
    const [y, m] = ym.split('-');
    return `${MONTH_NAMES[parseInt(m) - 1]}/${y.slice(2)}`;
  });

  const ctx = document.getElementById('chartMensal').getContext('2d');
  if (chartMensal) chartMensal.destroy();

  chartMensal = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets },
    options: {
      ...chartDefaults(),
      plugins: {
        ...chartDefaults().plugins,
        tooltip: {
          callbacks: {
            label: ctx => ` ${ctx.dataset.label}: ${fmtBRL(ctx.raw || 0)}`,
            footer: items => `Total: ${fmtBRL(items.reduce((s, i) => s + (i.raw || 0), 0))}`,
          }
        }
      }
    }
  });
}

// === SECTION: CHART ‚Äî DONUT ===
function buildDonutChart(movs) {
  const totals = allClasses.map(cls =>
    movs.filter(m => m.macroClasse === cls).reduce((s, m) => s + m.valor, 0)
  );

  const ctx = document.getElementById('chartDonut').getContext('2d');
  if (chartDonut) chartDonut.destroy();

  chartDonut = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: allClasses.map(classLabel),
      datasets: [{
        data: totals,
        backgroundColor: allClasses.map(classColor),
        borderWidth: 2,
        borderColor: isDark() ? '#2d2d2d' : '#ffffff',
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      cutout: '62%',
      animation: { duration: 400 },
      plugins: {
        legend: {
          labels: { color: tickColor(), font: { size: 11 }, boxWidth: 12 },
          position: 'bottom',
        },
        tooltip: {
          callbacks: {
            label: ctx => {
              const total = ctx.dataset.data.reduce((s, v) => s + v, 0);
              const pct = total > 0 ? ((ctx.raw / total) * 100).toFixed(1) : 0;
              return ` ${ctx.label}: ${fmtBRL(ctx.raw)} (${pct}%)`;
            }
          }
        }
      }
    }
  });
}

// === SECTION: MONTH RANGE TAB ===
function setMonthRange(n, btn) {
  monthRange = n;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  buildMensalChart(allMovs);
}

function refreshAll() {
  updateKPIs();
  buildAnualChart(allMovs);
  buildMensalChart(allMovs);
  buildDonutChart(allMovs);
}

function refreshChartThemes() {
  // Rebuild all charts so axis/legend colors update
  refreshAll();
}

// === SECTION: INIT ===
(async () => {
  try {
    await loadData();
    refreshAll();
  } catch (err) {
    document.getElementById('loadingOverlay').innerHTML =
      `<div style="background:#fff3;padding:2rem;border-radius:12px;text-align:center;">
        <p style="color:#fff;font-size:1rem;">‚ùå Erro ao carregar dados</p>
        <p style="color:#ffcdd2;font-size:0.85rem;margin-top:0.5rem;">${err.message}</p>
      </div>`;
    return;
  }
  document.getElementById('loadingOverlay').classList.add('hidden');
})();
</script>
</body>
</html>
