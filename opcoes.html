<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="only light">
  <meta name="supported-color-schemes" content="light">
  <title>üìä Dashboard de Op√ß√µes</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      color-scheme: only light !important;
      isolation: isolate;
      --bg: #f7fafc;
      --text: #2d3748;
      --surface: #ffffff;
      --card-bg: var(--surface);
      --border: #e2e8f0;
      --text-muted: #718096;
      --subtext: var(--text-muted);
      --primary: #667eea;
      --accent: var(--primary);
      --success: #48bb78;
      --warning: #ed8936;
      --shadow: 0 1px 3px rgba(0,0,0,.08), 0 4px 16px rgba(0,0,0,.06);
      --blue: #2196F3;
      --green: #4CAF50;
      --red: #f44336;
      --yellow: #FFC107;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html {
      background-color: var(--bg);
      min-height: 100vh;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO+ip1sAAAAASUVORK5CYII=');
      background-repeat: repeat;
      background-color: var(--bg);
      color: var(--text);
      transition: background-color 0.3s, color 0.3s;
      padding: 10px 10px 60px 10px;
      min-height: 100vh;
    }

    .nav-link {
      text-decoration: none;
      color: var(--primary);
      font-size: 0.9rem;
      margin: 10px 0 0 4px;
      display: inline-block;
    }

    h1 {
      text-align: center;
      font-size: 1.5rem;
      font-weight: 800;
      margin: 10px 44px 20px 44px;
      color: var(--text);
    }

    /* KPIs */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .kpi-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 8px;
      text-align: center;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .kpi-label {
      font-size: 0.6rem;
      font-weight: 800;
      color: var(--subtext);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      order: 1;
    }

    .kpi-value {
      font-size: 1.05rem;
      font-weight: 800;
      color: var(--text);
      line-height: 1.2;
      order: 2;
    }

    .kpi-value.positive { color: var(--green); }
    .kpi-value.negative { color: var(--red); }
    .kpi-value.warning { color: var(--yellow); }

    .kpi-sub {
      font-size: 0.65rem;
      color: var(--text-muted);
      font-weight: 600;
      order: 3;
    }

    /* Cards */
    .card {
      background: var(--surface);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
      transition: background-color 0.3s, border-color 0.3s;
    }

    .card h3 {
      font-size: 1rem;
      margin-bottom: 12px;
      color: var(--text);
      font-weight: 700;
      text-align: center;
    }

    /* Charts */
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .chart-container {
      position: relative;
      height: 300px;
    }

    #chartFluxoAtivo {
      height: auto !important;
    }

    @media (min-width: 768px) {
      .kpi-grid {
        grid-template-columns: repeat(4, 1fr);
      }
      .kpi-value {
        font-size: 1.3rem;
      }
      .charts-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .chart-container {
        height: 380px;
      }
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    thead {
      background: #f5f5f5;
      font-weight: bold;
    }

    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }

    tr:hover {
      background: #f9f9f9;
    }

    .venc-7dias {
      background: #FFF9C4 !important;
    }

    .venc-3dias {
      background: #FFE0B2 !important;
    }

    footer {
      text-align: center;
      margin-top: 40px;
      padding: 20px;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      font-size: 1.2rem;
      color: var(--text-muted);
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <a href="index.html" class="nav-link">‚Üê Voltar ao Hub</a>
  
  <h1>üìä Dashboard de Op√ß√µes</h1>

  <div id="loading" class="loading">Carregando dados...</div>

  <div id="content" class="hidden">
    <!-- KPIs -->
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">Fluxo Total</div>
        <div class="kpi-value" id="kpiFluxoTotal">--</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Fluxo M√™s</div>
        <div class="kpi-value" id="kpiFluxoMes">--</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Ops Abertas</div>
        <div class="kpi-value" id="kpiAbertas">--</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Venc. 7 Dias</div>
        <div class="kpi-value" id="kpiVencendo">--</div>
      </div>
    </div>

    <!-- Gr√°ficos -->
    <div class="charts-grid">
      <div class="card">
        <h3>üìà Fluxo de Caixa Mensal</h3>
        <div class="chart-container">
          <canvas id="chartFluxoMensal"></canvas>
        </div>
      </div>

      <div class="card">
        <h3>üéØ Resultado por Ativo</h3>
        <div class="chart-container" id="containerFluxoAtivo">
          <canvas id="chartFluxoAtivo"></canvas>
        </div>
      </div>
    </div>

    <!-- Tabela -->
    <div class="card">
      <h3>üìã Opera√ß√µes Abertas</h3>
      <div style="overflow-x: auto;">
        <table id="tabelaAbertas">
          <thead>
            <tr>
              <th>Ativo</th>
              <th>Ticker</th>
              <th>Tipo</th>
              <th>Vencimento</th>
              <th>Qtd</th>
              <th>Pre√ßo</th>
              <th>Dias</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <footer>
      <p>Atualizado em: <span id="dataAtualizacao">--</span></p>
    </footer>
  </div>

  <script>
    // ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ
    function brl(v) {
      return 'R$ ' + v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatDate(dateStr) {
      const [y, m, d] = dateStr.split('-');
      return `${d}/${m}/${y}`;
    }

    function diasAteVencimento(dataVenc) {
      const hoje = new Date();
      hoje.setHours(0, 0, 0, 0);
      const venc = new Date(dataVenc);
      venc.setHours(0, 0, 0, 0);
      const diff = Math.ceil((venc - hoje) / (1000*60*60*24));
      return diff;
    }

    function monthLabel(mesStr) {
      const [ano, mes] = mesStr.split('-');
      const mesNome = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'][parseInt(mes)-1];
      return `${mesNome}/${ano.slice(2)}`;
    }

    // ‚îÄ‚îÄ‚îÄ CALCULAR FLUXO POR ATIVO ‚îÄ‚îÄ‚îÄ
    function calcularFluxoPorAtivo(operacoes, campoAtivo) {
      const fluxo = {};
      
      operacoes.forEach(op => {
        const ativo = op[campoAtivo];
        if (!fluxo[ativo]) fluxo[ativo] = 0;
        
        // Fluxo de abertura
        const sinal_ab = (op.operacao === 'Venda') ? 1 : -1;
        const fc_ab = (op.preco_opcao_abertura * op.quantidade * sinal_ab) - op.taxas_abertura;
        fluxo[ativo] += fc_ab;
        
        // Fluxo de fechamento
        if (op.status === 'fechada') {
          const sinal_fc = (op.operacao === 'Venda') ? -1 : 1;
          const fc_fc = (op.preco_opcao_fechamento * op.quantidade * sinal_fc) - op.taxas_fechamento;
          fluxo[ativo] += fc_fc;
        }
      });
      
      return fluxo;
    }

    // ‚îÄ‚îÄ‚îÄ CONTAR VENCIMENTOS ‚îÄ‚îÄ‚îÄ
    function contarVencimentos(operacoes) {
      const hoje = new Date();
      const limite = new Date(hoje.getTime() + 7*24*60*60*1000);
      
      return operacoes.filter(op => {
        if (op.status !== 'aberta') return false;
        const venc = new Date(op.vencimento);
        return venc <= limite && venc >= hoje;
      }).length;
    }

    // ‚îÄ‚îÄ‚îÄ RENDER KPIs ‚îÄ‚îÄ‚îÄ
    function renderKPIs(fluxoData, brData, usData) {
      // KPI 1: Fluxo Total
      const fluxoTotal = fluxoData.totais.total_geral_brl;
      const el1 = document.getElementById('kpiFluxoTotal');
      el1.textContent = brl(fluxoTotal);
      el1.className = 'kpi-value ' + (fluxoTotal >= 0 ? 'positive' : 'negative');

      // KPI 2: Fluxo M√™s Atual
      const mesAtual = new Date().toISOString().slice(0,7);
      const fluxoMes = fluxoData.fluxo_mensal.find(m => m.mes === mesAtual)?.total_brl || 0;
      const el2 = document.getElementById('kpiFluxoMes');
      el2.textContent = brl(fluxoMes);
      el2.className = 'kpi-value ' + (fluxoMes >= 0 ? 'positive' : 'negative');

      // KPI 3: Opera√ß√µes Abertas
      const ops_br = brData.estatisticas.operacoes_abertas;
      const ops_us = usData.estatisticas.operacoes_abertas;
      const total_abertas = ops_br + ops_us;
      document.getElementById('kpiAbertas').textContent = total_abertas;

      // KPI 4: Vencendo em 7 dias
      const vencBR = contarVencimentos(brData.operacoes);
      const vencUS = contarVencimentos(usData.operacoes);
      const total_vencendo = vencBR + vencUS;
      const el4 = document.getElementById('kpiVencendo');
      el4.textContent = total_vencendo;
      el4.className = 'kpi-value ' + (total_vencendo > 0 ? 'warning' : '');
    }

    // ‚îÄ‚îÄ‚îÄ RENDER GR√ÅFICO FLUXO MENSAL ‚îÄ‚îÄ‚îÄ
    function renderFluxoMensal(fluxoData) {
      const ctx = document.getElementById('chartFluxoMensal').getContext('2d');
      
      const labels = fluxoData.fluxo_mensal.map(m => monthLabel(m.mes));
      const dataBR = fluxoData.fluxo_mensal.map(m => m.br_brl);
      const dataUS = fluxoData.fluxo_mensal.map(m => m.us_brl);

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'BR',
              data: dataBR,
              backgroundColor: '#2196F3',
              borderRadius: 4
            },
            {
              label: 'US',
              data: dataUS,
              backgroundColor: '#4CAF50',
              borderRadius: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { 
              stacked: true, 
              grid: { display: false },
              ticks: { font: { size: 10 } }
            },
            y: { 
              stacked: true,
              ticks: {
                callback: (value) => brl(value),
                font: { size: 10 }
              },
              grid: { color: '#e2e8f0' }
            }
          },
          plugins: {
            legend: { 
              position: 'bottom',
              labels: { boxWidth: 12, font: { size: 10 } }
            },
            tooltip: {
              callbacks: {
                label: (ctx) => ctx.dataset.label + ': ' + brl(ctx.parsed.y)
              }
            }
          }
        }
      });
    }

    // ‚îÄ‚îÄ‚îÄ RENDER GR√ÅFICO FLUXO POR ATIVO ‚îÄ‚îÄ‚îÄ
    function renderFluxoAtivo(brData, usData) {
      const fluxoBR = calcularFluxoPorAtivo(brData.operacoes, 'acao');
      const fluxoUS = calcularFluxoPorAtivo(usData.operacoes, 'ticker');

      // Converter US para BRL (cota√ß√£o m√©dia 5.50)
      const cotacaoMedia = 5.50;
      Object.keys(fluxoUS).forEach(k => {
        fluxoUS[k] *= cotacaoMedia;
      });

      // Consolidar
      const fluxoConsolidado = {...fluxoBR};
      Object.keys(fluxoUS).forEach(k => {
        fluxoConsolidado[k] = (fluxoConsolidado[k] || 0) + fluxoUS[k];
      });

      // Ordenar do MAIOR para o MENOR (n√£o por valor absoluto)
      const ativos = Object.entries(fluxoConsolidado)
        .sort((a,b) => b[1] - a[1]); // Maior primeiro

      const labels = ativos.map(a => a[0]);
      const valores = ativos.map(a => a[1]);
      const cores = valores.map(v => v >= 0 ? '#4CAF50' : '#f44336');

      // Altura din√¢mica baseada no n√∫mero de ativos
      const container = document.getElementById('containerFluxoAtivo');
      const alturaBase = 30; // px por ativo
      const alturaPadding = 40;
      const alturaTotal = (ativos.length * alturaBase) + alturaPadding;
      container.style.height = alturaTotal + 'px';

      const canvas = document.getElementById('chartFluxoAtivo');
      canvas.style.height = alturaTotal + 'px';

      new Chart(canvas.getContext('2d'), {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            data: valores,
            backgroundColor: cores,
            borderRadius: 4,
            barPercentage: 0.7
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: {
                callback: (value) => brl(value),
                font: { size: 9 }
              },
              grid: { color: '#e2e8f0' }
            },
            y: {
              ticks: { font: { size: 9 } },
              grid: { display: false }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => brl(ctx.parsed.x)
              }
            }
          }
        }
      });
    }

    // ‚îÄ‚îÄ‚îÄ RENDER TABELA ‚îÄ‚îÄ‚îÄ
    function renderTabela(brData, usData) {
      const tbody = document.querySelector('#tabelaAbertas tbody');
      
      // Filtrar opera√ß√µes abertas
      const abertas = [
        ...brData.operacoes.filter(op => op.status === 'aberta').map(op => ({
          ...op,
          ativo: op.acao,
          tickerOpcao: op.ticker_opcao,
          moeda: 'BRL'
        })),
        ...usData.operacoes.filter(op => op.status === 'aberta').map(op => ({
          ...op,
          ativo: op.ticker,
          tickerOpcao: op.ticker,
          moeda: 'USD'
        }))
      ];

      // Ordenar por vencimento
      abertas.sort((a, b) => new Date(a.vencimento) - new Date(b.vencimento));

      // Renderizar linhas
      abertas.forEach(op => {
        const dias = diasAteVencimento(op.vencimento);
        const tr = document.createElement('tr');
        
        // Aplicar destaque
        if (dias <= 3) {
          tr.className = 'venc-3dias';
        } else if (dias <= 7) {
          tr.className = 'venc-7dias';
        }

        const preco = op.moeda === 'BRL' 
          ? 'R$ ' + op.preco_opcao_abertura.toFixed(2)
          : '$' + op.preco_opcao_abertura.toFixed(2);

        tr.innerHTML = `
          <td>${op.ativo}</td>
          <td>${op.tickerOpcao || '--'}</td>
          <td>${op.tipo_contrato}</td>
          <td>${formatDate(op.vencimento)}</td>
          <td>${op.quantidade}</td>
          <td>${preco}</td>
          <td>${dias}</td>
        `;
        
        tbody.appendChild(tr);
      });
    }

    // ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
    async function init() {
      try {
        const [fluxoReq, brReq, usReq] = await Promise.all([
          fetch('data/fluxo_caixa_opcoes_mensal.json?v=' + Date.now()),
          fetch('data/opcoes_br.json?v=' + Date.now()),
          fetch('data/opcoes_intl.json?v=' + Date.now())
        ]);

        const fluxoData = await fluxoReq.json();
        const brData = await brReq.json();
        const usData = await usReq.json();

        renderKPIs(fluxoData, brData, usData);
        renderFluxoMensal(fluxoData);
        renderFluxoAtivo(brData, usData);
        renderTabela(brData, usData);

        document.getElementById('dataAtualizacao').textContent = 
          brData.data_atualizacao || fluxoData.data_geracao || '--';

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');

      } catch(err) {
        alert('Erro ao carregar dados: ' + err.message);
        console.error(err);
      }
    }

    init();
  </script>
</body>
</html>
