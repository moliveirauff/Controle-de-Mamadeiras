<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="only light">
  <meta name="supported-color-schemes" content="light">
  <title>üìä Dashboard de Op√ß√µes</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <style>
    :root {
      color-scheme: only light !important;
      isolation: isolate;
      --bg: #f7fafc;
      --text: #2d3748;
      --surface: #ffffff;
      --card-bg: var(--surface);
      --border: #e2e8f0;
      --text-muted: #718096;
      --subtext: var(--text-muted);
      --primary: #667eea;
      --accent: var(--primary);
      --success: #48bb78;
      --warning: #ed8936;
      --shadow: 0 1px 3px rgba(0,0,0,.08), 0 4px 16px rgba(0,0,0,.06);
      --blue: #2196F3;
      --green: #4CAF50;
      --red: #f44336;
      --yellow: #FFC107;
    }

    body.dark-mode {
      color-scheme: only dark !important;
      --bg: #1a202c;
      --text: #f7fafc;
      --surface: #2d3748;
      --card-bg: var(--surface);
      --border: #4a5568;
      --text-muted: #cbd5e0;
      --subtext: var(--text-muted);
      --primary: #7f9cf5;
      --accent: var(--primary);
      background-color: var(--bg);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html {
      background-color: var(--bg);
      min-height: 100vh;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      transition: background-color 0.3s, color 0.3s;
      padding: 10px 10px 60px 10px;
      min-height: 100vh;
    }

    #theme-toggle {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(0,0,0,0.05);
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: background 0.2s;
    }

    body.dark-mode #theme-toggle { background: rgba(255,255,255,0.1); }
    body:not(.dark-mode) #theme-toggle { background: rgba(0,0,0,0.05); }

    .nav-link {
      text-decoration: none;
      color: var(--primary);
      font-size: 0.9rem;
      margin: 10px 0 0 4px;
      display: inline-block;
    }

    h1 {
      text-align: center;
      font-size: 1.5rem;
      font-weight: 800;
      margin: 10px 44px 20px 44px;
      color: var(--text);
    }

    /* KPIs */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .kpi-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 8px;
      text-align: center;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 4px;
      transition: background-color 0.3s, border-color 0.3s;
    }

    .kpi-label {
      font-size: 0.6rem;
      font-weight: 800;
      color: var(--subtext);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      order: 1;
    }

    .kpi-value {
      font-size: 1.05rem;
      font-weight: 800;
      color: var(--text);
      line-height: 1.2;
      order: 2;
    }

    .kpi-value.positive { color: var(--green); }
    .kpi-value.negative { color: var(--red); }
    .kpi-value.warning { color: var(--yellow); }

    .kpi-sub {
      font-size: 0.65rem;
      color: var(--text-muted);
      font-weight: 600;
      order: 3;
    }

    /* Cards */
    .card {
      background: var(--surface);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
      transition: background-color 0.3s, border-color 0.3s;
    }

    .card h3 {
      font-size: 1rem;
      margin-bottom: 12px;
      color: var(--text);
      font-weight: 700;
      text-align: center;
    }

    /* Charts */
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .chart-container {
      position: relative;
      height: 300px;
    }

    #chartFluxoAtivo {
      height: auto !important;
    }

    @media (min-width: 768px) {
      .kpi-grid {
        grid-template-columns: repeat(4, 1fr);
      }
      .kpi-value {
        font-size: 1.3rem;
      }
      .charts-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .chart-container {
        height: 380px;
      }
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    thead {
      background: #f5f5f5;
      font-weight: bold;
    }

    body.dark-mode thead {
      background: var(--border);
    }

    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }

    tr:hover {
      background: rgba(0,0,0,0.02);
    }

    body.dark-mode tr:hover {
      background: rgba(255,255,255,0.05);
    }

    .venc-7dias {
      background: #FFF9C4 !important;
    }

    .venc-3dias {
      background: #FFE0B2 !important;
    }

    body.dark-mode .venc-7dias {
      background: rgba(255,249,196,0.2) !important;
    }

    body.dark-mode .venc-3dias {
      background: rgba(255,224,178,0.3) !important;
    }

    footer {
      text-align: center;
      margin-top: 40px;
      padding: 20px;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      font-size: 1.2rem;
      color: var(--text-muted);
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <button id="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">üåô</button>
  <a href="index.html" class="nav-link">‚Üê Voltar ao Hub</a>
  
  <h1>üìä Dashboard de Op√ß√µes</h1>

  <div id="loading" class="loading">Carregando dados...</div>

  <div id="content" class="hidden">
    <!-- KPIs -->
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">Fluxo Total</div>
        <div class="kpi-value" id="kpiFluxoTotal">--</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Fluxo M√™s</div>
        <div class="kpi-value" id="kpiFluxoMes">--</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Ops Abertas</div>
        <div class="kpi-value" id="kpiAbertas">--</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Venc. 7 Dias</div>
        <div class="kpi-value" id="kpiVencendo">--</div>
      </div>
    </div>

    <!-- Gr√°ficos -->
    <div class="charts-grid">
      <div class="card">
        <h3>üìà Fluxo de Caixa Mensal</h3>
        <div class="chart-container">
          <canvas id="chartFluxoMensal"></canvas>
        </div>
      </div>

      <div class="card">
        <h3>üìä % Retorno Mensal + Acumulado</h3>
        <div class="chart-container">
          <canvas id="chartRetorno"></canvas>
        </div>
      </div>
    </div>

    <!-- Gr√°fico Full Width -->
    <div class="card">
      <h3>üéØ Resultado por Ativo</h3>
      <div class="chart-container" id="containerFluxoAtivo">
        <canvas id="chartFluxoAtivo"></canvas>
      </div>
    </div>

    <!-- Tabela -->
    <div class="card">
      <h3>üìã Opera√ß√µes Abertas</h3>
      <div style="overflow-x: auto;">
        <table id="tabelaAbertas">
          <thead>
            <tr>
              <th>Ativo</th>
              <th>Ticker</th>
              <th>Tipo</th>
              <th>Strike</th>
              <th>Dias</th>
              <th>Vencimento</th>
              <th>Qtd</th>
              <th>Pre√ßo</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <footer>
      <p>Atualizado em: <span id="dataAtualizacao">--</span></p>
    </footer>
  </div>

  <script>
    /*
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë ESTRUTURA ESPERADA DO JSON: fluxo_caixa_opcoes_mensal.json                  ‚ïë
    ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
    ‚ïë                                                                              ‚ïë
    ‚ïë {                                                                            ‚ïë
    ‚ïë   "versao": "1.0",                                                           ‚ïë
    ‚ïë   "data_geracao": "YYYY-MM-DD HH:MM:SS",                                     ‚ïë
    ‚ïë   "totais": {                                                                ‚ïë
    ‚ïë     "br_total_brl": number,                                                  ‚ïë
    ‚ïë     "us_total_usd": number,                                                  ‚ïë
    ‚ïë     "us_total_brl": number,                                                  ‚ïë
    ‚ïë     "total_geral_brl": number  ‚Üê USADO NO DASHBOARD                         ‚ïë
    ‚ïë   },                                                                         ‚ïë
    ‚ïë   "fluxo_mensal": [            ‚Üê ARRAY COM ESTE NOME (n√£o detalhamento_mensal) ‚ïë
    ‚ïë     {                                                                        ‚ïë
    ‚ïë       "mes": "YYYY-MM",                                                      ‚ïë
    ‚ïë       "br_brl": number,        ‚Üê CAMPOS COM ESTE NOME (n√£o fluxo_br)        ‚ïë
    ‚ïë       "us_usd": number,                                                      ‚ïë
    ‚ïë       "us_brl": number,        ‚Üê (n√£o fluxo_us)                              ‚ïë
    ‚ïë       "total_brl": number      ‚Üê (n√£o fluxo_total)                           ‚ïë
    ‚ïë     },                                                                       ‚ïë
    ‚ïë     ...                                                                      ‚ïë
    ‚ïë   ]                                                                          ‚ïë
    ‚ïë }                                                                            ‚ïë
    ‚ïë                                                                              ‚ïë
    ‚ïë ‚ö†Ô∏è  N√ÉO deve conter registro com mes: "TOTAL" no array fluxo_mensal         ‚ïë
    ‚ïë ‚ö†Ô∏è  Totais devem estar APENAS no objeto "totais" no topo                    ‚ïë
    ‚ïë                                                                              ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    */

    // Desabilitar datalabels globalmente
    Chart.defaults.set('plugins.datalabels', { display: false });

    // ‚îÄ‚îÄ‚îÄ THEME ‚îÄ‚îÄ‚îÄ
    function updateMetaThemeColor(isDark) {
      const color = isDark ? '#1a202c' : '#f7fafc';
      const scheme = isDark ? 'only dark' : 'only light';
      
      let metaTheme = document.querySelector('meta[name="theme-color"]');
      if (!metaTheme) {
        metaTheme = document.createElement('meta');
        metaTheme.name = 'theme-color';
        document.head.appendChild(metaTheme);
      }
      metaTheme.content = color;

      let metaScheme = document.querySelector('meta[name="color-scheme"]');
      if (!metaScheme) {
        metaScheme = document.createElement('meta');
        metaScheme.name = 'color-scheme';
        document.head.appendChild(metaScheme);
      }
      metaScheme.content = scheme;
    }

    function initTheme() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      let isDark = false;
      if (savedTheme === 'dark') {
        isDark = true;
      } else if (savedTheme === 'light') {
        isDark = false;
      } else if (prefersDark) {
        isDark = true;
      }
      
      if (isDark) {
        document.body.classList.add('dark-mode');
        document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è';
      } else {
        document.body.classList.remove('dark-mode');
        document.getElementById('theme-toggle').textContent = 'üåô';
      }
      updateMetaThemeColor(isDark);
    }

    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      document.getElementById('theme-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
      updateMetaThemeColor(isDark);
      
      setTimeout(() => {
        if (window.chartsRendered) {
          renderAll();
        }
      }, 50);
    }

    // ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ
    function brl(v) {
      return 'R$ ' + v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatDate(dateStr) {
      const [y, m, d] = dateStr.split('-');
      return `${d}/${m}/${y}`;
    }

    function diasAteVencimento(dataVenc) {
      const hoje = new Date();
      hoje.setHours(0, 0, 0, 0);
      const venc = new Date(dataVenc);
      venc.setHours(0, 0, 0, 0);
      const diff = Math.ceil((venc - hoje) / (1000*60*60*24));
      return diff;
    }

    function monthLabel(mesStr) {
      const [ano, mes] = mesStr.split('-');
      const mesNome = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'][parseInt(mes)-1];
      return `${mesNome}/${ano.slice(2)}`;
    }

    // ‚îÄ‚îÄ‚îÄ CALCULAR FLUXO POR ATIVO ‚îÄ‚îÄ‚îÄ
    function calcularFluxoPorAtivo(operacoes, campoAtivo) {
      const fluxo = {};
      
      operacoes.forEach(op => {
        const ativo = op[campoAtivo];
        if (!fluxo[ativo]) fluxo[ativo] = 0;
        
        const sinal_ab = (op.operacao === 'Venda') ? 1 : -1;
        const fc_ab = (op.preco_opcao_abertura * op.quantidade * sinal_ab) - op.taxas_abertura;
        fluxo[ativo] += fc_ab;
        
        if (op.status === 'fechada') {
          const sinal_fc = (op.operacao === 'Venda') ? -1 : 1;
          const fc_fc = (op.preco_opcao_fechamento * op.quantidade * sinal_fc) - op.taxas_fechamento;
          fluxo[ativo] += fc_fc;
        }
      });
      
      return fluxo;
    }

    // ‚îÄ‚îÄ‚îÄ CONTAR VENCIMENTOS ‚îÄ‚îÄ‚îÄ
    function contarVencimentos(operacoes) {
      const hoje = new Date();
      const limite = new Date(hoje.getTime() + 7*24*60*60*1000);
      
      return operacoes.filter(op => {
        if (op.status !== 'aberta') return false;
        const venc = new Date(op.vencimento);
        return venc <= limite && venc >= hoje;
      }).length;
    }

    // ‚îÄ‚îÄ‚îÄ GLOBAL DATA ‚îÄ‚îÄ‚îÄ
    let globalData = {};

    // ‚îÄ‚îÄ‚îÄ RENDER KPIs ‚îÄ‚îÄ‚îÄ
    function renderKPIs(fluxoData, brData, usData) {
      const fluxoTotal = fluxoData.totais.total_geral_brl;
      const el1 = document.getElementById('kpiFluxoTotal');
      el1.textContent = brl(fluxoTotal);
      el1.className = 'kpi-value ' + (fluxoTotal >= 0 ? 'positive' : 'negative');

      const mesAtual = new Date().toISOString().slice(0,7);
      const fluxoMes = fluxoData.fluxo_mensal.find(m => m.mes === mesAtual)?.total_brl || 0;
      const el2 = document.getElementById('kpiFluxoMes');
      el2.textContent = brl(fluxoMes);
      el2.className = 'kpi-value ' + (fluxoMes >= 0 ? 'positive' : 'negative');

      const ops_br = brData.estatisticas.operacoes_abertas;
      const ops_us = usData.estatisticas.operacoes_abertas;
      const total_abertas = ops_br + ops_us;
      document.getElementById('kpiAbertas').textContent = total_abertas;

      const vencBR = contarVencimentos(brData.operacoes);
      const vencUS = contarVencimentos(usData.operacoes);
      const total_vencendo = vencBR + vencUS;
      const el4 = document.getElementById('kpiVencendo');
      el4.textContent = total_vencendo;
      el4.className = 'kpi-value ' + (total_vencendo > 0 ? 'warning' : '');
    }

    // ‚îÄ‚îÄ‚îÄ RENDER GR√ÅFICO FLUXO MENSAL ‚îÄ‚îÄ‚îÄ
    function renderFluxoMensal(fluxoData) {
      const ctx = document.getElementById('chartFluxoMensal').getContext('2d');
      const textColor = getComputedStyle(document.body).getPropertyValue('--text').trim();
      const gridColor = getComputedStyle(document.body).getPropertyValue('--border').trim();
      
      const labels = fluxoData.fluxo_mensal.map(m => monthLabel(m.mes));
      const dataBR = fluxoData.fluxo_mensal.map(m => m.br_brl);
      const dataUS = fluxoData.fluxo_mensal.map(m => m.us_brl);

      if (globalData.chartFluxoMensal) globalData.chartFluxoMensal.destroy();
      globalData.chartFluxoMensal = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'BR',
              data: dataBR,
              backgroundColor: '#2196F3',
              borderRadius: 4
            },
            {
              label: 'US',
              data: dataUS,
              backgroundColor: '#4CAF50',
              borderRadius: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { 
              stacked: true, 
              grid: { display: false },
              ticks: { font: { size: 10 }, color: textColor }
            },
            y: { 
              stacked: true,
              ticks: {
                callback: (value) => brl(value),
                font: { size: 10 },
                color: textColor
              },
              grid: { color: gridColor }
            }
          },
          plugins: {
            legend: { 
              position: 'bottom',
              labels: { boxWidth: 12, font: { size: 10 }, color: textColor }
            },
            tooltip: {
              callbacks: {
                label: (ctx) => ctx.dataset.label + ': ' + brl(ctx.parsed.y)
              }
            }
          }
        }
      });
    }

    // ‚îÄ‚îÄ‚îÄ RENDER GR√ÅFICO % RETORNO ‚îÄ‚îÄ‚îÄ
    function renderRetorno(fluxoData, investData) {
      const ctx = document.getElementById('chartRetorno').getContext('2d');
      const textColor = getComputedStyle(document.body).getPropertyValue('--text').trim();
      const gridColor = getComputedStyle(document.body).getPropertyValue('--border').trim();

      // Buscar saldo total de a√ß√µes + internacional + cripto
      const alocacao = investData.alocacao || [];
      const saldoAcoes = alocacao.find(a => a.categoria === '3_acoes_brasil')?.real_rs || 0;
      const saldoInternacional = alocacao.find(a => a.categoria === '5_internacional')?.real_rs || 0;
      const saldoCripto = alocacao.find(a => a.categoria === '6_criptoativos')?.real_rs || 0;
      const saldoTotal = saldoAcoes + saldoInternacional + saldoCripto;

      if (saldoTotal === 0) {
        // Criar gr√°fico vazio se n√£o houver saldo
        return;
      }

      const labels = fluxoData.fluxo_mensal.map(m => monthLabel(m.mes));
      
      // Calcular % retorno mensal
      const retornoMensal = fluxoData.fluxo_mensal.map(m => 
        (m.total_brl / saldoTotal) * 100
      );

      // Calcular % retorno acumulado
      let acumulado = 0;
      const retornoAcumulado = fluxoData.fluxo_mensal.map(m => {
        acumulado += m.total_brl;
        return (acumulado / saldoTotal) * 100;
      });

      if (globalData.chartRetorno) globalData.chartRetorno.destroy();
      globalData.chartRetorno = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              type: 'bar',
              label: '% Retorno M√™s',
              data: retornoMensal,
              backgroundColor: retornoMensal.map(v => v >= 0 ? '#4CAF50' : '#f44336'),
              borderRadius: 4,
              yAxisID: 'y'
            },
            {
              type: 'line',
              label: '% Retorno Acumulado',
              data: retornoAcumulado,
              borderColor: '#667eea',
              backgroundColor: 'rgba(102, 126, 234, 0.1)',
              borderWidth: 2,
              tension: 0.3,
              yAxisID: 'y1',
              pointRadius: 3,
              pointHoverRadius: 5
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { 
              grid: { display: false },
              ticks: { font: { size: 10 }, color: textColor }
            },
            y: {
              type: 'linear',
              position: 'left',
              ticks: {
                callback: (value) => value.toFixed(1) + '%',
                font: { size: 10 },
                color: textColor
              },
              grid: { color: gridColor }
            },
            y1: {
              type: 'linear',
              position: 'right',
              ticks: {
                callback: (value) => value.toFixed(1) + '%',
                font: { size: 10 },
                color: textColor
              },
              grid: { display: false }
            }
          },
          plugins: {
            legend: { 
              position: 'bottom',
              labels: { boxWidth: 12, font: { size: 10 }, color: textColor }
            },
            tooltip: {
              callbacks: {
                label: (ctx) => ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(2) + '%'
              }
            }
          }
        }
      });
    }

    // ‚îÄ‚îÄ‚îÄ RENDER GR√ÅFICO FLUXO POR ATIVO ‚îÄ‚îÄ‚îÄ
    function renderFluxoAtivo(brData, usData) {
      const textColor = getComputedStyle(document.body).getPropertyValue('--text').trim();
      const gridColor = getComputedStyle(document.body).getPropertyValue('--border').trim();

      const fluxoBR = calcularFluxoPorAtivo(brData.operacoes, 'acao');
      const fluxoUS = calcularFluxoPorAtivo(usData.operacoes, 'ticker');

      const cotacaoMedia = 5.50;
      Object.keys(fluxoUS).forEach(k => {
        fluxoUS[k] *= cotacaoMedia;
      });

      const fluxoConsolidado = {...fluxoBR};
      Object.keys(fluxoUS).forEach(k => {
        fluxoConsolidado[k] = (fluxoConsolidado[k] || 0) + fluxoUS[k];
      });

      const positivos = Object.entries(fluxoConsolidado).filter(a => a[1] >= 0);
      const negativos = Object.entries(fluxoConsolidado).filter(a => a[1] < 0);

      positivos.sort((a,b) => b[1] - a[1]);
      negativos.sort((a,b) => b[1] - a[1]);

      const ativos = [...positivos, ...negativos];

      const labels = ativos.map(a => a[0]);
      const valoresReais = ativos.map(a => a[1]);
      const valoresAbsolutos = valoresReais.map(v => Math.abs(v));
      const cores = valoresReais.map(v => v >= 0 ? '#4CAF50' : '#f44336');

      const container = document.getElementById('containerFluxoAtivo');
      const alturaBase = 30;
      const alturaPadding = 40;
      const alturaTotal = (ativos.length * alturaBase) + alturaPadding;
      container.style.height = alturaTotal + 'px';

      const canvas = document.getElementById('chartFluxoAtivo');
      canvas.style.height = alturaTotal + 'px';

      if (globalData.chartFluxoAtivo) globalData.chartFluxoAtivo.destroy();
      globalData.chartFluxoAtivo = new Chart(canvas.getContext('2d'), {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            data: valoresAbsolutos,
            backgroundColor: cores,
            borderRadius: 4,
            barPercentage: 0.7,
            datalabels: {
              display: true,
              anchor: 'end',
              align: 'end',
              offset: 4,
              formatter: (value, ctx) => brl(valoresReais[ctx.dataIndex]),
              font: { size: 8, weight: 'bold' },
              color: textColor
            }
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { right: 80 } },
          scales: {
            x: {
              ticks: {
                callback: (value) => brl(value),
                font: { size: 9 },
                color: textColor
              },
              grid: { color: gridColor }
            },
            y: {
              ticks: { font: { size: 9 }, color: textColor },
              grid: { display: false }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => brl(valoresReais[ctx.dataIndex])
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    // ‚îÄ‚îÄ‚îÄ RENDER TABELA ‚îÄ‚îÄ‚îÄ
    function renderTabela(brData, usData) {
      const tbody = document.querySelector('#tabelaAbertas tbody');
      
      const abertas = [
        ...brData.operacoes.filter(op => op.status === 'aberta').map(op => ({
          ...op,
          ativo: op.acao,
          tickerOpcao: op.ticker_opcao,
          moeda: 'BRL'
        })),
        ...usData.operacoes.filter(op => op.status === 'aberta').map(op => ({
          ...op,
          ativo: op.ticker,
          tickerOpcao: op.ticker,
          moeda: 'USD'
        }))
      ];

      abertas.sort((a, b) => new Date(a.vencimento) - new Date(b.vencimento));

      abertas.forEach(op => {
        const dias = diasAteVencimento(op.vencimento);
        const tr = document.createElement('tr');
        
        if (dias <= 3) {
          tr.className = 'venc-3dias';
        } else if (dias <= 7) {
          tr.className = 'venc-7dias';
        }

        const preco = op.moeda === 'BRL' 
          ? 'R$ ' + op.preco_opcao_abertura.toFixed(2)
          : '$' + op.preco_opcao_abertura.toFixed(2);

        const strike = op.strike 
          ? (op.moeda === 'BRL' ? 'R$ ' + op.strike.toFixed(2) : '$' + op.strike.toFixed(2))
          : '--';

        tr.innerHTML = `
          <td>${op.ativo}</td>
          <td>${op.tickerOpcao || '--'}</td>
          <td>${op.tipo_contrato}</td>
          <td>${strike}</td>
          <td>${dias}</td>
          <td>${formatDate(op.vencimento)}</td>
          <td>${op.quantidade}</td>
          <td>${preco}</td>
        `;
        
        tbody.appendChild(tr);
      });
    }

    // ‚îÄ‚îÄ‚îÄ RENDER ALL ‚îÄ‚îÄ‚îÄ
    function renderAll() {
      if (!globalData.fluxoData || !globalData.brData || !globalData.usData || !globalData.investData) {
        return;
      }

      renderKPIs(globalData.fluxoData, globalData.brData, globalData.usData);
      renderFluxoMensal(globalData.fluxoData);
      renderRetorno(globalData.fluxoData, globalData.investData);
      renderFluxoAtivo(globalData.brData, globalData.usData);
    }

    // ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
    async function init() {
      try {
        const [fluxoReq, brReq, usReq, investReq] = await Promise.all([
          fetch('data/fluxo_caixa_opcoes_mensal.json?v=' + Date.now()),
          fetch('data/opcoes_br.json?v=' + Date.now()),
          fetch('data/opcoes_intl.json?v=' + Date.now()),
          fetch('data/dashboard_investimentos.json?v=' + Date.now())
        ]);

        globalData.fluxoData = await fluxoReq.json();
        globalData.brData = await brReq.json();
        globalData.usData = await usReq.json();
        globalData.investData = await investReq.json();

        renderAll();
        renderTabela(globalData.brData, globalData.usData);

        document.getElementById('dataAtualizacao').textContent = 
          globalData.brData.data_atualizacao || globalData.fluxoData.data_geracao || '--';

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');

        window.chartsRendered = true;

      } catch(err) {
        alert('Erro ao carregar dados: ' + err.message);
        console.error(err);
      }
    }

    initTheme();
    init();
  </script>
</body>
</html>
