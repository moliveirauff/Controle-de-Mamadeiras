<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="only light">
  <meta name="supported-color-schemes" content="light">
  <title>üè† Im√≥veis de Renda</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <style>
    /* Force Light Mode variables as default, override if class is present */
    :root {
      color-scheme: only light !important;
      isolation: isolate;
      --bg: #f7fafc;
      --text: #2d3748;
      --surface: #ffffff;
      --card-bg: var(--surface);
      --border: #e2e8f0;
      --text-muted: #718096;
      --subtext: var(--text-muted);
      --primary: #667eea;
      --accent: var(--primary);
      --success: #48bb78;
      --warning: #ed8936;
      --danger: #f56565;
      --shadow: 0 1px 3px rgba(0,0,0,.08), 0 4px 16px rgba(0,0,0,.06);
    }
    
    /* Apply Dark Mode only when class is present */
    body.dark-mode {
      color-scheme: only dark !important;
      --bg: #1a202c;
      --text: #f7fafc;
      --surface: #2d3748;
      --card-bg: var(--surface);
      --border: #4a5568;
      --text-muted: #cbd5e0;
      --subtext: var(--text-muted);
      --primary: #7f9cf5;
      --accent: var(--primary);
      background-image: none;
      background-color: var(--bg);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html {
      background-color: var(--bg);
      min-height: 100vh;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      transition: background-color 0.3s, color 0.3s;
      padding: 10px 10px 60px 10px;
      min-height: 100vh;
    }

    /* Header */
    #theme-toggle {
      position: absolute; top: 12px; right: 12px;
      background: rgba(0,0,0,0.05); border: none; font-size: 1.2rem; cursor: pointer;
      padding: 8px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      z-index: 10; transition: background 0.2s;
    }
    body.dark-mode #theme-toggle { background: rgba(255,255,255,0.1); }
    body:not(.dark-mode) #theme-toggle { background: rgba(0,0,0,0.05); }
    .nav-link {
      text-decoration: none;
      color: var(--primary);
      font-size: 0.9rem;
      margin: 10px 0 0 4px;
      display: inline-block;
    }
    h1 {
      text-align: center;
      font-size: 1.5rem;
      font-weight: 800;
      margin: 10px 44px 20px 44px;
      color: var(--text);
    }

    /* KPIs */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    .kpi-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 8px;
      text-align: center;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .kpi-label {
      font-size: 0.6rem;
      font-weight: 800;
      color: var(--subtext);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      order: 1;
    }
    .kpi-value {
      font-size: 1.05rem;
      font-weight: 800;
      color: var(--text);
      line-height: 1.2;
      order: 2;
    }
    .kpi-sub {
      font-size: 0.65rem;
      color: var(--text-muted);
      font-weight: 600;
      order: 3;
    }

    /* Cards */
    .card {
      background: var(--surface);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
      transition: background-color 0.3s, border-color 0.3s;
    }
    .card-header {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .card-title { 
      display: flex; 
      align-items: center; 
      gap: 6px;
      text-align: center;
      width: 100%;
      justify-content: center;
    }
    .card-header .controls {
      width: 100%;
      justify-content: center;
    }

    /* Chart */
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }

    /* Controls */
    .controls { 
      display: flex; 
      gap: 6px; 
      align-items: center; 
      flex-wrap: wrap;
      justify-content: center;
    }
    .filter-btn {
      background: var(--border);
      border: none;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }
    .filter-btn:hover { opacity: 0.8; }
    .filter-btn.active { background: var(--accent); color: white; }

    /* Loading */
    #loading {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      color: white;
      font-weight: bold;
      backdrop-filter: blur(4px);
    }
    .hidden { display: none !important; }

    /* Desktop */
    @media (min-width: 768px) {
      body { max-width: 960px; margin: 0 auto; padding: 16px 16px 60px 16px; }
      h1 { font-size: 1.75rem; }
      .kpi-grid { grid-template-columns: repeat(4, 1fr); gap: 12px; }
      .chart-container { height: 380px; }
    }
  </style>
</head>
<body>

<div id="loading">Carregando dados...</div>

<button id="theme-toggle" onclick="toggleTheme()">üåô</button>
<a href="index.html" class="nav-link">‚Üê Voltar</a>
<h1>üè† Im√≥veis de Renda</h1>

<main>
  <!-- KPIs -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <span class="kpi-label">üè† Im√≥veis</span>
      <span class="kpi-value" id="kpiNumImoveis">‚Äî</span>
      <span class="kpi-sub">Propriedades</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-label">üí∞ Valor de Mercado</span>
      <span class="kpi-value" id="kpiValorMercado">‚Äî</span>
      <span class="kpi-sub">Atual</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-label">üìÖ Alugu√©is 12M</span>
      <span class="kpi-value" id="kpiAlugueis">‚Äî</span>
      <span class="kpi-sub" id="kpiDY">‚Äî</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-label">üìà Rentabilidade</span>
      <span class="kpi-value" id="kpiRentabilidade">‚Äî</span>
      <span class="kpi-sub">Total Acumulada</span>
    </div>
  </div>

  <!-- Gr√°fico 1: Valor do Im√≥vel + Rentabilidade Acumulada -->
  <div class="card">
    <div class="card-header">
      <div class="card-title"><span>üìä</span> Valor do Im√≥vel + Rentabilidade Acumulada</div>
    </div>
    <div class="chart-container">
      <canvas id="chartValor"></canvas>
    </div>
  </div>

  <!-- Gr√°fico 2: Alugu√©is Anuais + DY Anual -->
  <div class="card">
    <div class="card-header">
      <div class="card-title"><span>üíµ</span> Alugu√©is Anuais + DY Anual</div>
    </div>
    <div class="chart-container">
      <canvas id="chartAlugueis"></canvas>
    </div>
  </div>

  <!-- Gr√°fico 3: Alugu√©is Recebidos por M√™s -->
  <div class="card">
    <div class="card-header">
      <div class="card-title"><span>üìÖ</span> Alugu√©is Recebidos por M√™s</div>
      <div class="controls">
        <button class="filter-btn active" onclick="filterMensal(12)">12M</button>
        <button class="filter-btn" onclick="filterMensal(24)">24M</button>
        <button class="filter-btn" onclick="filterMensal(36)">36M</button>
        <button class="filter-btn" onclick="filterMensal(0)">Todos</button>
      </div>
    </div>
    <div class="chart-container">
      <canvas id="chartAlugueisMensal"></canvas>
    </div>
  </div>
</main>

<script>
// === STATE ===
let data = null;
let alugueisHistorico = null;
let aportesHistorico = null;
let charts = {};
let currentFilterMensal = 12;

// === INIT ===
async function init() {
  try {
    const [dashResp, alugResp, aportResp] = await Promise.all([
      fetch('data/imoveis_renda_dashboard.json'),
      fetch('data/recebimento_aluguel_historico.json'),
      fetch('data/imovel_trulli_historico.json')
    ]);
    
    data = await dashResp.json();
    alugueisHistorico = await alugResp.json();
    aportesHistorico = await aportResp.json();
    
    renderAll();
    document.getElementById('loading').classList.add('hidden');
  } catch (e) {
    alert('Erro ao carregar dados: ' + e.message);
    console.error(e);
  }
}

function renderAll() {
  updateKPIs();
  renderValor();
  renderAlugueis();
  renderAlugueisMensal();
}

// === KPIS ===
function updateKPIs() {
  const kpis = data.kpis;
  
  setTxt('kpiNumImoveis', kpis.num_imoveis);
  setTxt('kpiValorMercado', fmt(kpis.valor_mercado_atual));
  setTxt('kpiAlugueis', fmt(kpis.alugueis_12m));
  setTxt('kpiDY', `DY 12M: ${kpis.dy_12m.toFixed(2)}%`);
  setTxt('kpiRentabilidade', kpis.rentabilidade_total.toFixed(2) + '%');
}

// === CALCULAR INVESTIMENTO ACUMULADO POR ANO ===
function calcularInvestidoAteAno() {
  const movs = aportesHistorico.movimentacoes || [];
  const investidoPorAno = {};
  
  let acumulado = 0;
  const aportesPorAno = {};
  
  // Agrupar aportes por ano
  movs.forEach(m => {
    if (m.tipo === 'APORTE' && m.data) {
      const ano = parseInt(m.data.substring(0, 4));
      if (!aportesPorAno[ano]) aportesPorAno[ano] = 0;
      aportesPorAno[ano] += m.valor_total || 0;
    }
  });
  
  // Calcular acumulado at√© cada ano
  const anos = Object.keys(aportesPorAno).sort();
  anos.forEach(ano => {
    acumulado += aportesPorAno[ano];
    investidoPorAno[ano] = acumulado;
  });
  
  return investidoPorAno;
}

// === GR√ÅFICO 1: VALOR DO IM√ìVEL + RENTABILIDADE ACUMULADA ===
function renderValor() {
  const ctx = getCtx('chartValor');
  const seriesValor = data.series.valor_por_ano;
  const investidoPorAno = calcularInvestidoAteAno();
  
  const anos = seriesValor.map(s => s.ano);
  const valores = seriesValor.map(s => s.valor);
  
  // Recalcular rentabilidade: (valor_final_ano / investido_ate_ano) - 1
  const rentabilidades = seriesValor.map(s => {
    const investido = investidoPorAno[s.ano] || 1;
    return ((s.valor / investido) - 1) * 100;
  });

  if (charts.valor) charts.valor.destroy();
  charts.valor = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: anos,
      datasets: [
        {
          label: 'Valor do Im√≥vel',
          data: valores,
          backgroundColor: '#10b981',
          borderRadius: 4,
          barPercentage: 0.6,
          yAxisID: 'y'
        },
        {
          label: 'Rentabilidade Acumulada (%)',
          data: rentabilidades,
          type: 'line',
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          borderWidth: 3,
          fill: false,
          tension: 0.4,
          pointRadius: 6,
          pointHoverRadius: 8,
          pointBackgroundColor: rentabilidades.map(r => r >= 0 ? '#10b981' : '#ef4444'),
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          yAxisID: 'y1'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: {
            color: getTextColor(),
            usePointStyle: true,
            padding: 15,
            font: { family: 'Inter', size: 11 }
          }
        },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              if (ctx.dataset.label.includes('Valor')) {
                return 'Valor: ' + fmt(ctx.raw);
              } else {
                return 'Rentabilidade: ' + ctx.raw.toFixed(2) + '%';
              }
            }
          }
        }
      },
      scales: {
        x: {
          ticks: { color: getTextColor(), font: { family: 'Inter' } },
          grid: { display: false }
        },
        y: {
          type: 'linear',
          position: 'left',
          ticks: {
            callback: (v) => compactFmt(v),
            color: getTextColor(),
            font: { family: 'Inter' }
          },
          grid: { color: getBorderColor() }
        },
        y1: {
          type: 'linear',
          position: 'right',
          ticks: {
            callback: (v) => v.toFixed(1) + '%',
            color: getTextColor(),
            font: { family: 'Inter' }
          },
          grid: { display: false }
        }
      },
      animation: {
        duration: 800,
        easing: 'easeInOutQuart'
      }
    }
  });
}

// === GR√ÅFICO 2: ALUGU√âIS ANUAIS + DY ANUAL ===
function renderAlugueis() {
  const ctx = getCtx('chartAlugueis');
  const seriesAlug = data.series.alugueis_por_ano;
  const seriesValor = data.series.valor_por_ano;
  
  const anos = seriesAlug.map(s => s.ano);
  const valores = seriesAlug.map(s => s.total);
  
  // Calcular DY anual: (total aluguel ano / valor im√≥vel fim do ano) √ó 100
  const dyAnual = seriesAlug.map(alug => {
    const valorFimAno = seriesValor.find(v => v.ano === alug.ano);
    if (!valorFimAno || valorFimAno.valor === 0) return 0;
    return (alug.total / valorFimAno.valor) * 100;
  });

  if (charts.alugueis) charts.alugueis.destroy();
  charts.alugueis = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: anos,
      datasets: [
        {
          label: 'Alugu√©is Recebidos',
          data: valores,
          backgroundColor: '#3b82f6',
          borderRadius: 4,
          barPercentage: 0.6,
          yAxisID: 'y'
        },
        {
          label: 'DY Anual (%)',
          data: dyAnual,
          type: 'line',
          borderColor: '#f39c12',
          backgroundColor: 'rgba(243, 156, 18, 0.1)',
          borderWidth: 3,
          fill: false,
          tension: 0.4,
          pointRadius: 6,
          pointHoverRadius: 8,
          pointBackgroundColor: '#f39c12',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          yAxisID: 'y1'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: {
            color: getTextColor(),
            usePointStyle: true,
            padding: 15,
            font: { family: 'Inter', size: 11 }
          }
        },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              if (ctx.dataset.label.includes('Alugu√©is')) {
                return 'Alugu√©is: ' + fmt(ctx.raw);
              } else {
                return 'DY: ' + ctx.raw.toFixed(2) + '%';
              }
            }
          }
        }
      },
      scales: {
        x: {
          ticks: { color: getTextColor(), font: { family: 'Inter' } },
          grid: { display: false }
        },
        y: {
          type: 'linear',
          position: 'left',
          ticks: {
            callback: (v) => compactFmt(v),
            color: getTextColor(),
            font: { family: 'Inter' }
          },
          grid: { color: getBorderColor() }
        },
        y1: {
          type: 'linear',
          position: 'right',
          ticks: {
            callback: (v) => v.toFixed(1) + '%',
            color: getTextColor(),
            font: { family: 'Inter' }
          },
          grid: { display: false }
        }
      },
      animation: {
        duration: 800,
        easing: 'easeInOutQuart'
      }
    }
  });
}

// === GR√ÅFICO 3: ALUGU√âIS RECEBIDOS POR M√äS ===
function renderAlugueisMensal() {
  const ctx = getCtx('chartAlugueisMensal');
  
  // Processar hist√≥rico de alugu√©is
  const movs = alugueisHistorico.movimentacoes || [];
  const alugueisMensais = {};
  
  movs.forEach(m => {
    if (m.tipo === 'PROVENTO_ALUGUEL' && m.data) {
      const mesAno = m.data.substring(0, 7); // YYYY-MM
      if (!alugueisMensais[mesAno]) {
        alugueisMensais[mesAno] = 0;
      }
      alugueisMensais[mesAno] += m.valor_total || 0;
    }
  });
  
  // Ordenar todos os meses (sem pular zeros)
  const mesesUnicos = Object.keys(alugueisMensais).sort();
  if (mesesUnicos.length === 0) return;
  
  const primeiroMes = mesesUnicos[0];
  const ultimoMes = mesesUnicos[mesesUnicos.length - 1];
  
  // Gerar range cont√≠nuo de meses
  const todosMeses = [];
  let mesAtual = primeiroMes;
  
  while (mesAtual <= ultimoMes) {
    todosMeses.push(mesAtual);
    
    // Incrementar m√™s
    let [ano, mes] = mesAtual.split('-').map(Number);
    mes++;
    if (mes > 12) {
      mes = 1;
      ano++;
    }
    mesAtual = `${ano}-${String(mes).padStart(2, '0')}`;
  }
  
  // Preencher valores (0 se n√£o houver)
  const valores = todosMeses.map(m => alugueisMensais[m] || 0);
  
  // Aplicar filtro temporal
  let mesesFiltrados = todosMeses;
  let valoresFiltrados = valores;
  
  if (currentFilterMensal > 0) {
    const inicio = Math.max(0, todosMeses.length - currentFilterMensal);
    mesesFiltrados = todosMeses.slice(inicio);
    valoresFiltrados = valores.slice(inicio);
  }
  
  // Formatar labels (MMM/YY)
  const labels = mesesFiltrados.map(m => {
    const [ano, mes] = m.split('-');
    const mesesNome = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
    return `${mesesNome[parseInt(mes) - 1]}/${ano.substring(2)}`;
  });

  if (charts.alugueisMensal) charts.alugueisMensal.destroy();
  charts.alugueisMensal = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Alugu√©is Mensais',
        data: valoresFiltrados,
        backgroundColor: '#1abc9c',
        borderRadius: 4,
        barPercentage: 0.7
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => fmt(ctx.raw)
          }
        }
      },
      scales: {
        x: {
          ticks: {
            color: getTextColor(),
            maxRotation: 45,
            minRotation: 45,
            font: { family: 'Inter', size: 10 }
          },
          grid: {
            display: false
          }
        },
        y: {
          ticks: {
            callback: (v) => compactFmt(v),
            color: getTextColor(),
            font: { family: 'Inter' }
          },
          grid: {
            color: getBorderColor()
          }
        }
      },
      animation: {
        duration: 800,
        easing: 'easeInOutQuart'
      }
    }
  });
}

// === FILTER MENSAL ===
function filterMensal(months) {
  currentFilterMensal = months;
  
  // Update button states
  document.querySelectorAll('.controls .filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  renderAlugueisMensal();
}

// === UTILS ===
function fmt(n) { 
  return n.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); 
}

function compactFmt(n) { 
  return Intl.NumberFormat('pt-BR', { 
    notation: "compact", 
    compactDisplay: "short" 
  }).format(n); 
}

function setTxt(id, t) { 
  document.getElementById(id).textContent = t; 
}

function getCtx(id) { 
  return document.getElementById(id).getContext('2d'); 
}

function getTextColor() {
  return getComputedStyle(document.body).getPropertyValue('--text').trim();
}

function getBorderColor() {
  return getComputedStyle(document.body).getPropertyValue('--border').trim();
}

// === THEME HANDLING ===
function updateMetaThemeColor(isDark) {
  const color = isDark ? '#1a202c' : '#f7fafc';
  const scheme = isDark ? 'only dark' : 'only light';
  
  let metaTheme = document.querySelector('meta[name="theme-color"]');
  if (!metaTheme) {
    metaTheme = document.createElement('meta');
    metaTheme.name = 'theme-color';
    document.head.appendChild(metaTheme);
  }
  metaTheme.content = color;

  let metaScheme = document.querySelector('meta[name="color-scheme"]');
  if (!metaScheme) {
    metaScheme = document.createElement('meta');
    metaScheme.name = 'color-scheme';
    document.head.appendChild(metaScheme);
  }
  metaScheme.content = scheme;
}

function initTheme() {
  const savedTheme = localStorage.getItem('theme');
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  
  let isDark = false;
  if (savedTheme === 'dark') {
    isDark = true;
  } else if (savedTheme === 'light') {
    isDark = false;
  } else if (prefersDark) {
    isDark = true;
  }
  
  if (isDark) {
    document.body.classList.add('dark-mode');
    document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è';
  } else {
    document.body.classList.remove('dark-mode');
    document.getElementById('theme-toggle').textContent = 'üåô';
  }
  updateMetaThemeColor(isDark);
}

function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  const isDark = document.body.classList.contains('dark-mode');
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
  document.getElementById('theme-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  updateMetaThemeColor(isDark);
  
  // Re-render charts para atualizar cores
  setTimeout(renderAll, 50);
}

// Inicializar tema ANTES de tudo
initTheme();

init();
</script>
</body>
</html>
